{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-南北系统专线-国贸采购业务数据全流程\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_sal.dwi_sal_lz_contract_delivery_delay_analysis;\n-- CREATE TABLE\n--     dwi_sal.dwi_sal_lz_contract_delivery_delay_analysis (\n--     -- 合同关联信息\n--     purordicode VARCHAR(500) COMMENT '采购订单编号',\n--     purordcode VARCHAR(500) COMMENT '采购订单代码',\n--     purordgicode VARCHAR(500) COMMENT '采购订单明细编号',\n--     purordcodex VARCHAR(500) COMMENT '采购订单扩展代码',\n    \n--     -- 到货关联信息\n--     purshipicode VARCHAR(500) COMMENT '到货单编号',\n--     purshipgicode VARCHAR(500) COMMENT '到货单明细编号',\n--     purshipcodex VARCHAR(500) COMMENT '到货单扩展代码',\n    \n--     -- 组织信息\n--     business_org_code VARCHAR(500) COMMENT '业务组织代码',\n--     owner_person_code VARCHAR(500) COMMENT '负责人代码',\n--     accounting_dept_code VARCHAR(500) COMMENT '会计部门代码',\n--     corp_org_code VARCHAR(500) COMMENT '法人组织代码',\n--     accounting_group_code VARCHAR(500) COMMENT '会计组代码',\n    \n--     -- 商品信息\n--     product_code VARCHAR(500) COMMENT '商品代码',\n--     product_category_code VARCHAR(500) COMMENT '商品分类代码',\n--     product_business_key VARCHAR(500) COMMENT '商品业务键',\n    \n--     -- 商品属性\n--     product_attr1 VARCHAR(500) COMMENT '商品属性1',\n--     product_attr2 VARCHAR(500) COMMENT '商品属性2',\n--     product_attr3 VARCHAR(500) COMMENT '商品属性3',\n--     product_attr4 VARCHAR(500) COMMENT '商品属性4',\n--     product_attr5 VARCHAR(500) COMMENT '商品属性5',\n--     reserved_attr1 VARCHAR(500) COMMENT '预留属性1',\n--     reserved_attr2 VARCHAR(500) COMMENT '预留属性2',\n--     reserved_attr3 VARCHAR(500) COMMENT '预留属性3',\n--     reserved_attr4 VARCHAR(500) COMMENT '预留属性4',\n--     reserved_attr5 VARCHAR(500) COMMENT '预留属性5',\n    \n--     -- 项目信息\n--     project_code VARCHAR(500) COMMENT '项目代码',\n--     project_icode VARCHAR(500) COMMENT '项目内部代码',\n    \n--     -- 合同数量信息\n--     contract_quantity DECIMAL(32,6) COMMENT '合同数量',\n--     contract_quantity_unit VARCHAR(500) COMMENT '合同数量单位',\n--     contract_stat_quantity DECIMAL(32,6) COMMENT '合同统计数量',\n--     contract_stat_unit VARCHAR(500) COMMENT '合同统计单位',\n--     contract_unit_price DECIMAL(32,6) COMMENT '合同单价',\n--     contract_amount DECIMAL(32,6) COMMENT '合同金额',\n    \n--     -- 到货数量信息\n--     delivery_quantity DECIMAL(32,6) COMMENT '到货数量',\n--     delivery_quantity_unit VARCHAR(500) COMMENT '到货数量单位',\n--     delivery_stat_quantity DECIMAL(32,6) COMMENT '到货统计数量',\n--     delivery_stat_unit VARCHAR(500) COMMENT '到货统计单位',\n--     delivery_unit_price DECIMAL(32,6) COMMENT '到货单价',\n--     delivery_amount DECIMAL(32,6) COMMENT '到货金额',\n    \n--     -- 时间信息\n--     contract_delivery_date DATE COMMENT '合同交货日期',\n--     actual_delivery_date DATE COMMENT '实际到货日期',\n--     delivery_date DATE COMMENT '预计到货日期(ETA)',\n    \n--     -- 币种汇率\n--     currency_code VARCHAR(500) COMMENT '币种代码',\n--     exchange_rate DECIMAL(32,6) COMMENT '汇率',\n    \n--     -- 延迟分析字段\n--     delivery_delay_days DECIMAL(18,2) COMMENT '交货延迟天数',\n--     is_delayed BOOLEAN COMMENT '是否延迟',\n--     is_overdue BOOLEAN COMMENT '是否逾期',\n--     overdue_days DECIMAL(18,2) COMMENT '逾期天数',\n    \n--     -- 审计字段\n--     data_date DATE COMMENT '数据日期',\n--     created_time TIMESTAMP COMMENT '创建时间',\n--     updated_time TIMESTAMP COMMENT '更新时间'\n--     )\n-- COMMENT '廉政八项-南北系统专线-国贸采购业务数据全流程'\n-- PARTITIONED BY (mt VARCHAR(500) COMMENT '分区月份')\n-- STORED AS ORC;\n\nINSERT OVERWRITE TABLE dwi_sal.dwi_sal_lz_contract_delivery_delay_analysis PARTITION (mt='2025-07')\n-- 填充采购合同到货延迟分析宽表\nSELECT \n    -- 合同关联信息\n    pcg.purordicode,\n    NULL AS purordcode,\n    pcg.purordgicode,\n    pcg.purordcodex,\n    \n    -- 到货关联信息\n    COALESCE(dg.purshipicode, NULL) as purshipicode,\n    COALESCE(dg.purshipgicode, NULL) as purshipgicode,\n    COALESCE(dg.purshipcodex, NULL) as purshipcodex,\n    \n    -- 组织信息\n    pcg.bcode as business_org_code,\n    pcg.wcode as owner_person_code,\n    pcg.keptbcode as accounting_dept_code,\n    pcg.corpbcode as corp_org_code,\n    pcg.jcode as accounting_group_code,\n    \n    -- 商品信息\n    pcg.gcode as product_code,\n    pcg.gicode as product_category_code,\n    pcg.gcodebusikey as product_business_key,\n    \n    -- 商品属性\n    pcg.gattr1 as product_attr1,\n    pcg.gattr2 as product_attr2,\n    pcg.gattr3 as product_attr3,\n    pcg.gattr4 as product_attr4,\n    pcg.gattr5 as product_attr5,\n    '','','','','',\n    -- 项目信息\n    pcg.prjcode as project_code,\n    pcg.prjicode as project_icode,\n    \n    -- 合同数量信息\n    pcg.qtc as contract_quantity,\n    pcg.qtcunit as contract_quantity_unit,\n    pcg.qty as contract_stat_quantity,\n    pcg.qtyunit as contract_stat_unit,\n    pcg.upric as contract_unit_price,\n    pcg.scy as contract_amount,\n    \n    -- 到货数量信息\n    COALESCE(dg.qtc, 0) as delivery_quantity,\n    COALESCE(dg.qtcunit, pcg.qtcunit) as delivery_quantity_unit,\n    COALESCE(dg.qty, 0) as delivery_stat_quantity,\n    COALESCE(dg.qtyunit, pcg.qtyunit) as delivery_stat_unit,\n    COALESCE(dg.upric, 0) as delivery_unit_price,\n    COALESCE(dg.scy, 0) as delivery_amount,\n    \n    -- 时间信息\n    pcg.deliverydate as contract_delivery_date,\n    dg.deliverydate as actual_delivery_date,\n    dg.eta as delivery_date,\n    \n    -- 币种汇率\n    pcg.fcode as currency_code,\n    pcg.fserate as exchange_rate,\n    \n    \n    -- 延迟分析字段\n    -- CASE \n    --     WHEN dg.eta IS NOT NULL AND pcg.deliverydate IS NOT NULL \n    --     THEN DATEDIFF(dg.eta, pcg.deliverydate)\n    --     ELSE NULL \n    -- END as delivery_delay_days,\n    \n    -- CASE \n    --     WHEN dg.eta IS NOT NULL AND pcg.deliverydate IS NOT NULL AND dg.eta > pcg.deliverydate \n    --     THEN 1 ELSE 0 \n    -- END as is_delayed,\n    \n    -- CASE \n    --     WHEN dg.purshipgicode IS NULL AND pcg.deliverydate < CURRENT_DATE() \n    --     THEN 1 ELSE 0 \n    -- END as is_overdue,\n    \n    -- CASE \n    --     WHEN dg.purshipgicode IS NULL AND pcg.deliverydate < CURRENT_DATE() \n    --     THEN DATEDIFF(CURRENT_DATE(), pcg.deliverydate)\n    --     ELSE NULL \n    -- END as overdue_days,\n        -- 延迟分析字段\n    NULL as delivery_delay_days,\n    \n    NULL as is_delayed,\n    \n    NULL as is_overdue,\n    \n    NULL as overdue_days,\n    -- 审计字段\n    -- CURRENT_DATE() as data_date,\n    -- NOW() as created_time,\n    -- NOW() as updated_time\n     CURRENT_DATE() ,CURRENT_DATE() ,CURRENT_DATE() \n    \nFROM dwi_sal_purorderg_n9 pcg\nLEFT JOIN dwi_sal_purshiporderg_n9 dg ON pcg.purordgicodex = dg.purordgicodex\nWHERE pcg.purordgicode IS NOT NULL;\n",
	"currentDatabase":"dwi_sal",
	"description":"",
	"directory":"/廉政专项/南北系统/宽表",
	"name":"etl_dwi_sal_lz_contract_delivery_delay_analysis",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}