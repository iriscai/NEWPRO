{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-南北系统专线-进口报关单关联详情宽表\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_sal.dwi_sal_lz_import_customs_detail;\n-- CREATE TABLE\n--     dwi_sal.dwi_sal_lz_import_customs_detail (\n--     -- 采购合同基础信息\n--     purordicode VARCHAR(500) COMMENT '采购合同号内码',\n--     purordcodex VARCHAR(500) COMMENT '采购合同核销号',\n--     purordgicodex VARCHAR(500) COMMENT '采购合同明细核销内码',\n--     pur_line_no VARCHAR(500) COMMENT '采购合同行号',\n    \n--     -- 商品物料信息\n--     gcode VARCHAR(500) COMMENT '基础商品大类码',\n--     gicode VARCHAR(500) COMMENT '商品分类内码',\n--     pur_gcodedesc VARCHAR(500) COMMENT '采购商品描述',\n--     pur_hscode VARCHAR(500) COMMENT '采购海关编码',\n--     specmodel VARCHAR(500) COMMENT '规格型号',\n--     gorigin VARCHAR(500) COMMENT '原产地',\n--     pur_gattr1 VARCHAR(500) COMMENT '采购商品属性1',\n--     pur_gattr2 VARCHAR(500) COMMENT '采购商品属性2',\n--     pur_gattr3 VARCHAR(500) COMMENT '采购商品属性3',\n--     rgcode VARCHAR(500) COMMENT '真实物料号',\n--     casno VARCHAR(500) COMMENT 'CAS号',\n--     barcode VARCHAR(500) COMMENT '条形码',\n    \n--     -- 项目信息\n--     prjcode VARCHAR(500) COMMENT '项目号',\n--     prjicode VARCHAR(500) COMMENT '项目号内码',\n    \n--     -- 组织人员信息\n--     bcode VARCHAR(500) COMMENT '业务组织',\n--     wcode VARCHAR(500) COMMENT '属主人员',\n--     corpbcode VARCHAR(500) COMMENT '法人组织',\n--     jcode VARCHAR(500) COMMENT '核算组',\n--     keptbcode VARCHAR(500) COMMENT '记账部门',\n    \n--     -- 供应商信息\n--     ccode VARCHAR(500) COMMENT '供应商',\n--     grpccode VARCHAR(500) COMMENT '公司客商',\n--     ccodetrust VARCHAR(500) COMMENT '委托方',\n--     grpccodetrust VARCHAR(500) COMMENT '委托方公司客商',\n    \n--     -- 采购数量金额\n--     pur_qty DECIMAL(32,6) COMMENT '采购统计数量',\n--     pur_qtyunit VARCHAR(500) COMMENT '采购统计单位',\n--     pur_qtc DECIMAL(32,6) COMMENT '采购合同数量',\n--     pur_qtcunit VARCHAR(500) COMMENT '采购合同单位',\n--     pur_qtx DECIMAL(32,6) COMMENT '采购包装数量',\n--     pur_qtxunit VARCHAR(500) COMMENT '采购包装单位',\n--     pur_fcy DECIMAL(32,6) COMMENT '采购原币金额',\n--     pur_scy DECIMAL(32,6) COMMENT '采购本位币金额',\n--     pur_rcy1 DECIMAL(32,6) COMMENT '采购报告币1金额',\n--     pur_rcy2 DECIMAL(32,6) COMMENT '采购报告币2金额',\n--     pur_upric DECIMAL(32,6) COMMENT '采购单价',\n--     pur_fcode VARCHAR(500) COMMENT '采购原币币种',\n    \n--     -- 采购贸易信息\n--     tradetype VARCHAR(500) COMMENT '贸易类型',\n--     pur_trademode VARCHAR(500) COMMENT '贸易方式',\n--     pur_loadingport VARCHAR(500) COMMENT '采购装货港',\n--     pur_dischargeport VARCHAR(500) COMMENT '采购卸货港',\n--     consigndate VARCHAR(500) COMMENT '交货期',\n--     deliverydate VARCHAR(500) COMMENT '交货日期',\n--     deliveryplace VARCHAR(500) COMMENT '交货地点',\n    \n--     -- 报关单聚合信息\n--     imp_total_qtc DECIMAL(32,6) COMMENT '报关总单据数量',\n--     imp_total_qty DECIMAL(32,6) COMMENT '报关总统计数量',\n--     imp_total_qtx DECIMAL(32,6) COMMENT '报关总包装数量',\n--     imp_qtyunit VARCHAR(500) COMMENT '报关统计单位',\n--     imp_total_fcy DECIMAL(32,6) COMMENT '报关总原币金额',\n--     imp_total_scy DECIMAL(32,6) COMMENT '报关总本位币金额',\n--     imp_total_rcy1 DECIMAL(32,6) COMMENT '报关总报告币1金额',\n--     imp_total_rcy2 DECIMAL(32,6) COMMENT '报关总报告币2金额',\n--     imp_fcode VARCHAR(500) COMMENT '报关原币币种',\n    \n--     -- 重量信息\n--     total_grossweight DECIMAL(32,6) COMMENT '总毛重',\n--     total_netweight DECIMAL(32,6) COMMENT '总净重',\n--     wtunit VARCHAR(500) COMMENT '重量单位',\n    \n--     -- 报关单统计信息\n--     detail_count DECIMAL(32,6) COMMENT '报关明细条数',\n--     customs_count DECIMAL(32,6) COMMENT '报关单数量',\n    \n--     -- 关联验证标识\n--     customs_status VARCHAR(500) COMMENT '报关状态',\n--     hscode_match_status VARCHAR(500) COMMENT '海关编码匹配状态',\n    \n--     -- 差异分析\n--     qty_diff DECIMAL(32,6) COMMENT '数量差异',\n--     amount_diff DECIMAL(32,6) COMMENT '金额差异（本位币）',\n--     amount_diff_rcy1 DECIMAL(32,6) COMMENT '金额差异（报告币1）',\n    \n--     -- 完成率计算\n--     customs_qty_rate DECIMAL(32,6) COMMENT '报关数量完成率',\n--     customs_amount_rate DECIMAL(32,6) COMMENT '报关金额完成率',\n    \n--     -- ETL信息\n--     create_time VARCHAR(500) COMMENT '宽表创建时间'\n--     )\n-- COMMENT '廉政八项-南北系统专线-进口报关单关联详情宽表'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\n \n -- 报关单明细聚合表\n DROP VIEW IF EXISTS imp_customs_aggregated;\nCREATE VIEW imp_customs_aggregated AS\nSELECT \n    -- 聚合维度\n    imp_g.purordcodex,                  -- 采购合同核销号\n    imp_g.gcode,                        -- 基础商品大类码\n    imp_g.gicode,                       -- 商品分类内码\n    imp_g.hscode,                       -- 海关编码\n    imp_g.prjcode,                      -- 项目号\n    imp_g.prjicode,                     -- 项目号内码\n    imp_g.ccode,                        -- 供应商\n    imp_g.grpccode,                     -- 公司客商\n    imp_g.bcode,                        -- 业务组织\n    imp_g.wcode,                        -- 属主人员\n    imp_g.corpbcode,                    -- 法人组织\n    imp_g.jcode,                        -- 核算组\n    imp_g.fcode,                        -- 原币币种\n    imp_g.qtyunit,                      -- 统计单位\n    \n    -- 数量聚合\n    SUM(imp_g.qtc) AS total_qtc,        -- 总单据数量\n    SUM(imp_g.qty) AS total_qty,        -- 总统计数量\n    SUM(imp_g.qtx) AS total_qtx,        -- 总包装数量\n    \n    -- 金额聚合\n    SUM(imp_g.fcy) AS total_fcy,        -- 总原币金额\n    SUM(imp_g.scy) AS total_scy,        -- 总本位币金额\n    SUM(imp_g.rcy1) AS total_rcy1,      -- 总报告币1金额\n    SUM(imp_g.rcy2) AS total_rcy2,      -- 总报告币2金额\n    -- 重量聚合\n    SUM(imp_g.wi_grossweight) AS total_grossweight, -- 总毛重\n    SUM(imp_g.wi_netweight) AS total_netweight,     -- 总净重\n    MAX(imp_g.wi_wtunit) AS wtunit,                 -- 重量单位\n    \n    -- 统计信息\n    COUNT(*) AS detail_count,           -- 明细条数\n    COUNT(DISTINCT imp_g.impclicode) AS customs_count -- 报关单数量\n\nFROM dwi_prc.dwi_prc_impcustomsg_n9 imp_g\n\nGROUP BY \n    imp_g.purordcodex, imp_g.gcode, imp_g.gicode, imp_g.hscode,\n    imp_g.prjcode, imp_g.prjicode, imp_g.ccode, imp_g.grpccode,\n    imp_g.bcode, imp_g.wcode, imp_g.corpbcode, imp_g.jcode,\n    imp_g.fcode, imp_g.qtyunit;\n\nINSERT OVERWRITE TABLE dwi_sal.dwi_sal_lz_import_customs_detail PARTITION (mt='2025-07')\n-- 采购合同与报关单关联验证宽表\nSELECT \n    -- 采购合同基础信息\n    pur.purordicode,                    -- 采购合同号内码\n    pur.purordcodex,                    -- 采购合同核销号\n    pur.purordgicodex,                  -- 采购合同明细核销内码\n    pur.idx AS pur_line_no,             -- 采购合同行号\n    \n    -- 商品物料信息\n    pur.gcode,                          -- 基础商品大类码\n    pur.gicode,                         -- 商品分类内码\n    pur.gcodedesc AS pur_gcodedesc,     -- 采购商品描述\n    pur.hscode AS pur_hscode,           -- 采购海关编码\n    pur.specmodel,                      -- 规格型号\n    pur.gorigin,                        -- 原产地\n    pur.gattr1 AS pur_gattr1,           -- 采购商品属性1\n    pur.gattr2 AS pur_gattr2,           -- 采购商品属性2\n    pur.gattr3 AS pur_gattr3,           -- 采购商品属性3\n    pur.rgcode,                         -- 真实物料号\n    pur.casno,                          -- CAS号\n    pur.barcode,                        -- 条形码\n    \n    -- 项目信息\n    pur.prjcode,                        -- 项目号\n    pur.prjicode,                       -- 项目号内码\n    \n    -- 组织人员信息\n    pur.bcode,                          -- 业务组织\n    pur.wcode,                          -- 属主人员\n    pur.corpbcode,                      -- 法人组织\n    pur.jcode,                          -- 核算组\n    pur.keptbcode,                      -- 记账部门\n    \n    -- 供应商信息\n    pur.ccode,                          -- 供应商\n    pur.grpccode,                       -- 公司客商\n    pur.ccodetrust,                     -- 委托方\n    pur.grpccodetrust,                  -- 委托方公司客商\n    \n    -- 采购数量金额\n    pur.qty AS pur_qty,                 -- 采购统计数量\n    pur.qtyunit AS pur_qtyunit,         -- 采购统计单位\n    pur.qtc AS pur_qtc,                 -- 采购合同数量\n    pur.qtcunit AS pur_qtcunit,         -- 采购合同单位\n    pur.qtx AS pur_qtx,                 -- 采购包装数量\n    pur.qtxunit AS pur_qtxunit,         -- 采购包装单位\n    \n    pur.fcy AS pur_fcy,                 -- 采购原币金额\n    pur.scy AS pur_scy,                 -- 采购本位币金额\n    pur.rcy1 AS pur_rcy1,               -- 采购报告币1金额\n    pur.rcy2 AS pur_rcy2,               -- 采购报告币2金额\n    pur.upric AS pur_upric,             -- 采购单价\n    pur.fcode AS pur_fcode,             -- 采购原币币种\n    \n    -- 采购贸易信息\n    pur.tradetype,                      -- 贸易类型\n    pur.trademode AS pur_trademode,     -- 贸易方式\n    pur.loadingport AS pur_loadingport, -- 采购装货港\n    pur.dischargeport AS pur_dischargeport, -- 采购卸货港\n    pur.consigndate,                    -- 交货期\n    pur.deliverydate,                   -- 交货日期\n    pur.deliveryplace,                  -- 交货地点\n    \n    -- 报关单聚合信息\n    imp.total_qtc AS imp_total_qtc,     -- 报关总单据数量\n    imp.total_qty AS imp_total_qty,     -- 报关总统计数量\n    imp.total_qtx AS imp_total_qtx,     -- 报关总包装数量\n    imp.qtyunit AS imp_qtyunit,         -- 报关统计单位\n    \n    imp.total_fcy AS imp_total_fcy,     -- 报关总原币金额\n    imp.total_scy AS imp_total_scy,     -- 报关总本位币金额\n    imp.total_rcy1 AS imp_total_rcy1,   -- 报关总报告币1金额\n    imp.total_rcy2 AS imp_total_rcy2,   -- 报关总报告币2金额\n    imp.fcode AS imp_fcode,             -- 报关原币币种\n    -- 重量信息\n    imp.total_grossweight,              -- 总毛重\n    imp.total_netweight,                -- 总净重\n    imp.wtunit,                         -- 重量单位\n    \n    -- 报关单统计信息\n    imp.detail_count,                   -- 报关明细条数\n    imp.customs_count,                  -- 报关单数量\n\n    -- 关联验证标识\n    CASE \n        WHEN imp.purordcodex IS NOT NULL THEN '已报关'\n        ELSE '未报关'\n    END AS customs_status,              -- 报关状态\n    \n    CASE \n        WHEN imp.purordcodex IS NOT NULL AND pur.hscode = imp.hscode THEN '海关编码一致'\n        WHEN imp.purordcodex IS NOT NULL AND pur.hscode != imp.hscode THEN '海关编码不一致'\n        ELSE '无报关单'\n    END AS hscode_match_status,         -- 海关编码匹配状态\n    \n    -- 差异分析\n    CASE \n        WHEN imp.total_qty IS NOT NULL THEN \n            pur.qty - imp.total_qty\n        ELSE pur.qty\n    END AS qty_diff,                    -- 数量差异\n    \n    CASE \n        WHEN imp.total_scy IS NOT NULL THEN \n            pur.scy - imp.total_scy\n        ELSE pur.scy\n    END AS amount_diff,                 -- 金额差异（本位币）\n    \n    CASE \n        WHEN imp.total_rcy1 IS NOT NULL THEN \n            pur.rcy1 - imp.total_rcy1\n        ELSE pur.rcy1\n    END AS amount_diff_rcy1,            -- 金额差异（报告币1）\n    \n    -- 完成率计算\n    CASE \n        WHEN pur.qty > 0 AND imp.total_qty IS NOT NULL THEN \n            ROUND(imp.total_qty / pur.qty * 100, 2)\n        ELSE 0\n    END AS customs_qty_rate,            -- 报关数量完成率\n    \n    CASE \n        WHEN pur.scy > 0 AND imp.total_scy IS NOT NULL THEN \n            ROUND(imp.total_scy / pur.scy * 100, 2)\n        ELSE 0\n    END AS customs_amount_rate,         -- 报关金额完成率\n    \n    -- ETL信息\n    \n    CURRENT_DATE()  AS create_time    -- 宽表创建时间\n\nFROM dwi_sal_purorderg_n9 pur\nLEFT JOIN imp_customs_aggregated imp \n    ON pur.purordcodex = imp.purordcodex\n    AND pur.gcode = imp.gcode\n    AND pur.prjcode = imp.prjcode\n    AND pur.ccode = imp.ccode\n    AND pur.bcode = imp.bcode\n    AND pur.wcode = imp.wcode\n\n-- 筛选进口相关的采购合同\nWHERE \n-- pur.tradetype IN ('进口', '进口贸易') \n--   OR pur.trademode LIKE '%进口%'\n--   OR pur.gorigin IS NOT NULL AND pur.gorigin != '中国'\n--   OR \n   pur.hscode IS NOT NULL;\n",
	"currentDatabase":"dwi_sal",
	"description":"",
	"directory":"/廉政专项/南北系统/宽表",
	"name":"etl_dwi_sal_lz_import_customs_detail",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}