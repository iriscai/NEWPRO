{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-南北系统专线-合同付款分析etl_dwi_sal_lz_contract_payment_analysis\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_sal.dwi_sal_lz_contract_payment_analysis;\n-- CREATE TABLE\n--     dwi_sal.dwi_sal_lz_contract_payment_analysis (\n--     -- 采购合同基础信息\n--     purordicode VARCHAR(500) COMMENT '采购合同号内码',\n--     purordcodex VARCHAR(500) COMMENT '采购合同核销号',\n--     purordgicodex VARCHAR(500) COMMENT '采购合同明细核销内码',\n--     pur_line_no VARCHAR(500) COMMENT '采购合同行号',\n    \n--     -- 商品物料信息\n--     gcode VARCHAR(500) COMMENT '基础商品大类码',\n--     gicode VARCHAR(500) COMMENT '商品分类内码',\n--     pur_gcodedesc VARCHAR(500) COMMENT '采购商品描述',\n--     pur_hscode VARCHAR(500) COMMENT '采购海关编码',\n--     specmodel VARCHAR(500) COMMENT '规格型号',\n--     gorigin VARCHAR(500) COMMENT '原产地',\n--     pur_gattr1 VARCHAR(500) COMMENT '采购商品属性1',\n--     pur_gattr2 VARCHAR(500) COMMENT '采购商品属性2',\n--     pur_gattr3 VARCHAR(500) COMMENT '采购商品属性3',\n--     rgcode VARCHAR(500) COMMENT '真实物料号',\n--     casno VARCHAR(500) COMMENT 'CAS号',\n--     barcode VARCHAR(500) COMMENT '条形码',\n    \n--     -- 项目信息\n--     prjcode VARCHAR(500) COMMENT '项目号',\n--     prjicode VARCHAR(500) COMMENT '项目号内码',\n    \n--     -- 组织人员信息\n--     bcode VARCHAR(500) COMMENT '业务组织',\n--     wcode VARCHAR(500) COMMENT '属主人员',\n--     corpbcode VARCHAR(500) COMMENT '法人组织',\n--     jcode VARCHAR(500) COMMENT '核算组',\n--     keptbcode VARCHAR(500) COMMENT '记账部门',\n    \n--     -- 供应商信息\n--     ccode VARCHAR(500) COMMENT '供应商',\n--     grpccode VARCHAR(500) COMMENT '公司客商',\n--     ccodetrust VARCHAR(500) COMMENT '委托方',\n--     grpccodetrust VARCHAR(500) COMMENT '委托方公司客商',\n    \n--     -- 采购数量金额\n--     pur_qty DECIMAL(32,6) COMMENT '采购统计数量',\n--     pur_qtyunit VARCHAR(500) COMMENT '采购统计单位',\n--     pur_qtc DECIMAL(32,6) COMMENT '采购合同数量',\n--     pur_qtcunit VARCHAR(500) COMMENT '采购合同单位',\n--     pur_qtx DECIMAL(32,6) COMMENT '采购包装数量',\n--     pur_qtxunit VARCHAR(500) COMMENT '采购包装单位',\n--     pur_fcy DECIMAL(32,6) COMMENT '采购原币金额',\n--     pur_scy DECIMAL(32,6) COMMENT '采购本位币金额',\n--     pur_rcy1 DECIMAL(32,6) COMMENT '采购报告币1金额',\n--     pur_rcy2 DECIMAL(32,6) COMMENT '采购报告币2金额',\n--     pur_upric DECIMAL(32,6) COMMENT '采购单价',\n--     pur_fcode VARCHAR(500) COMMENT '采购原币币种',\n    \n--     -- 采购贸易信息\n--     tradetype VARCHAR(500) COMMENT '贸易类型',\n--     pur_trademode VARCHAR(500) COMMENT '贸易方式',\n--     pur_loadingport VARCHAR(500) COMMENT '采购装货港',\n--     pur_dischargeport VARCHAR(500) COMMENT '采购卸货港',\n--     consigndate VARCHAR(500) COMMENT '交货期',\n--     deliverydate VARCHAR(500) COMMENT '交货日期',\n--     deliveryplace VARCHAR(500) COMMENT '交货地点',\n    \n--     -- 报关单聚合信息\n--     imp_total_qtc DECIMAL(32,6) COMMENT '报关总单据数量',\n--     imp_total_qty DECIMAL(32,6) COMMENT '报关总统计数量',\n--     imp_total_qtx DECIMAL(32,6) COMMENT '报关总包装数量',\n--     imp_qtyunit VARCHAR(500) COMMENT '报关统计单位',\n--     imp_total_fcy DECIMAL(32,6) COMMENT '报关总原币金额',\n--     imp_total_scy DECIMAL(32,6) COMMENT '报关总本位币金额',\n--     imp_total_rcy1 DECIMAL(32,6) COMMENT '报关总报告币1金额',\n--     imp_total_rcy2 DECIMAL(32,6) COMMENT '报关总报告币2金额',\n--     imp_fcode VARCHAR(500) COMMENT '报关原币币种',\n    \n--     -- 重量信息\n--     total_grossweight DECIMAL(32,6) COMMENT '总毛重',\n--     total_netweight DECIMAL(32,6) COMMENT '总净重',\n--     wtunit VARCHAR(500) COMMENT '重量单位',\n    \n--     -- 报关单统计信息\n--     detail_count DECIMAL(32,6) COMMENT '报关明细条数',\n--     customs_count DECIMAL(32,6) COMMENT '报关单数量',\n    \n--     -- 关联验证标识\n--     customs_status VARCHAR(500) COMMENT '报关状态',\n--     hscode_match_status VARCHAR(500) COMMENT '海关编码匹配状态',\n    \n--     -- 差异分析\n--     qty_diff DECIMAL(32,6) COMMENT '数量差异',\n--     amount_diff DECIMAL(32,6) COMMENT '金额差异（本位币）',\n--     amount_diff_rcy1 DECIMAL(32,6) COMMENT '金额差异（报告币1）',\n    \n--     -- 完成率计算\n--     customs_qty_rate DECIMAL(32,6) COMMENT '报关数量完成率',\n--     customs_amount_rate DECIMAL(32,6) COMMENT '报关金额完成率',\n    \n--     -- ETL信息\n--     create_time VARCHAR(500) COMMENT '宽表创建时间'\n--     )\n-- COMMENT '廉政八项-南北系统专线-合同付款分析'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\n \n -- 报关单明细聚合表\n DROP VIEW IF EXISTS imp_customs_aggregated;\n-- 步骤1：创建结算数据聚合临时表\nCREATE TEMPORARY TABLE temp_settlement_summary AS\nSELECT \n    -- 聚合维度\n    so.cuicode,                            -- 供应商（使用结算单主表的商户内码）\n    sg.gcode,                              -- 料号\n    so.wcode,                              -- 业务员\n    so.bcode,                              -- 业务组织\n    \n    -- 聚合结算数据\n    COUNT(DISTINCT so.settlordicode) as settlement_count,\n    SUM(sg.scy) as total_settlement_amount,\n    SUM(sg.qtc) as total_settlement_qtc,\n    SUM(sg.qty) as total_settlement_qty,\n    \n    -- 保留明细信息用于关联\n    GROUP_CONCAT(DISTINCT so.settlordicode) as settlement_codes,\n    GROUP_CONCAT(DISTINCT sg.settlordergicode) as settlement_detail_codes\n    \nFROM dwi_prc.dwi_prc_settlorder_n9 so\nINNER JOIN dwi_prc.dwi_prc_settlorderg_n9 sg ON so.settlordicode = sg.settlordicode\nWHERE so.settlordicode IS NOT NULL\n  AND sg.settlordergicode IS NOT NULL\nGROUP BY so.cuicode, sg.gcode, so.wcode, so.bcode;\n\n-- 步骤2：填充宽表（关联合同与结算数据）\nINSERT INTO wide_table_contract_payment_analysis\nSELECT \n    NULL as record_id,\n    \n    -- 采购合同主表信息\n    po.purordicode,\n    po.purordcode,\n    po.purordcodex,\n    po.cuicode,\n    po.status,\n    po.signdate,\n    po.effectdate,\n    po.enddate,\n    po.scy as contract_total_amount,\n    po.fcode,\n    po.fserate,\n    \n    -- 采购合同明细信息\n    pg.purordgicode,\n    pg.ptgicodex,\n    pg.salordersgicodex,\n    pg.purordgicodex,\n    pg.salordgicodex,\n    pg.salordicodex,\n    pg.salordcodex,\n    pg.upgicodex,\n    pg.idx,\n    pg.bcode,\n    pg.keptbcode,\n    pg.wcode,\n    pg.corpbcode,\n    pg.jcode,\n    pg.sap_newgcode,\n    \n    -- 项目信息\n    pg.prjcode,\n    pg.prjicode,\n    \n    -- 商品信息(料号)\n    pg.gcode,\n    pg.gicode,\n    pg.gcodebusikey,\n    pg.gattr1,\n    pg.gattr2,\n    pg.gattr3,\n    pg.gattr4,\n    pg.gattr5,\n    pg.gattr6,\n    pg.gattr7,\n    pg.gattr8,\n    pg.gattr9,\n    pg.gattr10,\n    \n    -- 合同数量金额信息\n    pg.qtx,\n    pg.qtc,\n    pg.qty,\n    pg.qtcunit,\n    pg.qtyunit,\n    pg.upric,\n    pg.scy as contract_scy,\n    pg.deliverydate,\n    pg.odate,\n    pg.ratifydate,\n    \n    -- 结算单主表信息\n    so.settlordicode,\n    so.settlordcode,\n    so.settlordcodex,\n    so.cuicode as settl_cuicode,\n    so.status as settl_status,\n    so.bcode as settl_bcode,\n    so.wcode as settl_wcode,\n    so.keptbcode as settl_keptbcode,\n    so.corpbcode as settl_corpbcode,\n    so.jcode as settl_jcode,\n    so.scy as settl_total_amount,\n    so.fcode as settl_fcode,\n    so.fserate as settl_fserate,\n    so.settldate,\n    so.paydate,\n    \n    -- 结算单明细信息\n    sg.settlordergicode,\n    sg.settlordergicodex,\n    sg.ingislcodex,\n    sg.islcode,\n    sg.islcodex,\n    sg.slcodex,\n    sg.odate as settl_odate,\n    sg.ratifydate as settl_ratifydate,\n    sg.outngicode,\n    sg.outngicodex,\n    sg.idx as settl_idx,\n    \n    -- 结算供应商信息\n    sg.ccode,\n    sg.grpccode,\n    sg.ccodetrust,\n    sg.grpccodetrust,\n    \n    -- 结算商品信息\n    sg.gcode as settl_gcode,\n    sg.gicode as settl_gicode,\n    sg.gcodebusikey as settl_gcodebusikey,\n    sg.gattr1 as settl_gattr1,\n    sg.gattr2 as settl_gattr2,\n    sg.gattr3 as settl_gattr3,\n    sg.gattr4 as settl_gattr4,\n    sg.gattr5 as settl_gattr5,\n    sg.gattr6 as settl_gattr6,\n    sg.gattr7 as settl_gattr7,\n    sg.gattr8 as settl_gattr8,\n    sg.gattr9 as settl_gattr9,\n    sg.gattr10 as settl_gattr10,\n    \n    -- 结算数量金额信息\n    sg.qtx as settl_qtx,\n    sg.qtc as settl_qtc,\n    sg.qty as settl_qty,\n    sg.qtcunit as settl_qtcunit,\n    sg.qtyunit as settl_qtyunit,\n    sg.upric as settl_upric,\n    sg.scy as settl_scy,\n    \n    -- 审计字段\n    CURDATE() as data_date,\n    NOW() as created_time,\n    NOW() as updated_time\n    \nFROM dwi_sal_purorder_n9 po\nINNER JOIN dwi_sal_purorderg_n9 pg ON po.purordicode = pg.purordicode\nLEFT JOIN dwi_prc_settlorderg_n9 sg ON pg.purordgicodex = sg.purordgicodex\nLEFT JOIN dwi_prc_settlorder_n9 so ON sg.settlordicode = so.settlordicode\nWHERE po.purordicode IS NOT NULL\n  AND pg.purordgicode IS NOT NULL;\n  \n  \n  \n  \n  \n  SELECT * FROM dwi_prc.dwi_prc_purshiplrp_n9\n\n  \n  \n  \n  \n  \n  \n  \n  \n  select * from dwi_sal_purordersettlement_n9\n\n\n",
	"currentDatabase":"dwi_sal",
	"description":"",
	"directory":"/廉政专项/南北系统/宽表",
	"name":"etl_dwi_sal_lz_contract_payment_analysis",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}