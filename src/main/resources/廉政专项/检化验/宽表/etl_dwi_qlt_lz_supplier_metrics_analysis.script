{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- SPARK sql \n-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-03\n-- descr: 廉政八项-检化验专线-检化验结果对比分析宽表\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_qlt.dwi_qlt_lz_supplier_metrics_analysis;\n-- CREATE TABLE\n-- \tdwi_qlt.dwi_qlt_lz_supplier_metrics_analysis (\n--         smp_no STRING COMMENT '样品编号',\n--         provid_no STRING COMMENT '供应商代码',\n--         sub_mat_no STRING COMMENT '物料类别代码',\n--         get_smp_day STRING COMMENT '取样日期',\n--         get_smp_time STRING COMMENT '取样时间',\n--         smp_site_no STRING COMMENT '取样地点代码',\n--         get_smp STRING COMMENT '取样人',\n--         smp_sender STRING COMMENT '送样人',\n--         smp_send_day STRING COMMENT '送样日期',\n--         smp_send_time STRING COMMENT '送样时间',\n--         smp_item STRING COMMENT '检验项目',\n--         test_rst STRING COMMENT '检验结果',\n--         smp_date STRING COMMENT '检验日期',\n--         smp_time STRING COMMENT '检验时间',\n--         tester STRING COMMENT '检验员',\n--         test_eqt_no STRING COMMENT '检验设备',\n--         note STRING COMMENT '备注'\n-- \t) COMMENT '检化验结果对比分析宽表' STORED AS orc TBLPROPERTIES (\"orc.compress\" = \"SNAPPY\");\n-- DROP VIEW IF EXISTS ods_nqis.ods_nqis_tx_sampinfo_f_view;\n-- CREATE VIEW ods_nqis.ods_nqis_tx_sampinfo_f_view AS \n-- SELECT * FROM ods_nqis.ods_nqis_tx_sampinfo_f WHERE dt=current_date-1 LIMIT 20;\n-- DROP VIEW IF EXISTS ods_nqis.ods_nqis_tx_analyresult_f_view;\n-- CREATE VIEW ods_nqis.ods_nqis_tx_analyresult_f_view AS \n-- SELECT * FROM ods_nqis.ods_nqis_tx_sampinfo_f WHERE dt=current_date-1;\n    \n-- 方案一：多指标计算\n-- SELECT\n--     CONCAT(smp.smp_no, '_', res.smp_item) AS id, -- 主键\n--     smp.smp_no AS smp_no, -- 样品编号\n--     smp.heat_no AS heat_no, -- 炉次号\n--     smp.sub_mat_no AS sub_mat_no, -- 物料类别代码\n--     smp.provid_no AS provid_no, -- 供应商代码\n--     smp.get_smp_day AS get_smp_day, -- 取样日期\n--     res.smp_date AS smp_date, -- 检验日期\n--     smp.smp_type AS smp_type, -- 试样类型\n--     res.smp_item AS smp_item, -- 检验项目\n--     res.test_rst AS test_rst, -- 检验结果\n--     CAST(res.test_rst AS DECIMAL(10, 3)) AS test_rst_value, -- 检验结果数值（转换后，实际可能需要清洗）\n--     res.test_std_no AS test_std_no, -- 试验标准编号\n--     res.tester AS tester, -- 检验员\n--     res.test_eqt_no AS test_eqt_no, -- 检验设备\n--     CAST(res.test_min AS DECIMAL(10, 3)) AS test_min, -- 最小值标准（转换后）\n--     CAST(res.test_max AS DECIMAL(10, 3)) AS test_max, -- 最大值标准（转换后）\n--     res.mat_std AS mat_std, -- 等级\n--     smp.judg_rst AS judg_rst, -- 审核结果\n--     smp.note AS note, -- 备注\n--     DATEDIFF(TO_DATE(res.smp_date, 'YYYYMMDD'), TO_DATE(smp.get_smp_day, 'YYYYMMDD')) AS diff_days, -- 日期差值\n--     -- 组内统计值（同一供应商、品类、项目、±7天）\n--     AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--         PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--         ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--         RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--     ) AS group_avg_value, -- 组内平均值\n--     MAX(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--         PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--         ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--         RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--     ) AS group_max_value, -- 组内最大值\n--     MIN(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--         PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--         ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--         RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--     ) AS group_min_value, -- 组内最小值\n--     STDDEV(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--         PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--         ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--         RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--     ) AS group_stddev_value, -- 组内标准差\n--     -- 与组内平均值的百分比差异\n--     CASE \n--         WHEN AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         ) = 0 THEN 0\n--         ELSE ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         )) / AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         ) * 100\n--     END AS percent_diff_to_avg,\n--     -- 与组内最大/最小值的绝对值差异\n--     GREATEST(\n--         ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - MAX(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         )),\n--         ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - MIN(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         ))\n--     ) AS abs_diff_to_max_min,\n--     -- 是否超出标准范围\n--     CASE \n--         WHEN CAST(res.test_rst AS DECIMAL(10, 3)) < CAST(res.test_min AS DECIMAL(10, 3)) \n--              OR CAST(res.test_rst AS DECIMAL(10, 3)) > CAST(res.test_max AS DECIMAL(10, 3))\n--         THEN TRUE\n--         ELSE FALSE\n--     END AS is_out_of_range,\n--     -- 是否高度相同（与组内平均值±5%以内）\n--     CASE \n--         WHEN ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         )) / AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         ) <= 0.05\n--         THEN TRUE\n--         ELSE FALSE\n--     END AS is_high_similarity,\n--     -- 是否差距较大（与组内平均值差异超过±20%）\n--     CASE \n--         WHEN ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         )) / AVG(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         ) > 0.2\n--         THEN TRUE\n--         ELSE FALSE\n--     END AS is_large_diff_percent,\n--     -- 是否差距较大（与组内最大/最小值绝对差异超过阈值，假设阈值为10）\n--     CASE \n--         WHEN GREATEST(\n--             ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - MAX(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--                 PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--                 ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--                 RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--             )),\n--             ABS(CAST(res.test_rst AS DECIMAL(10, 3)) - MIN(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--                 PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--                 ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--                 RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--             ))\n--         ) > 10\n--         THEN TRUE\n--         ELSE FALSE\n--     END AS is_large_diff_abs,\n--     -- 是否差距较大（组内标准差超过阈值，假设阈值为5）\n--     CASE \n--         WHEN STDDEV(CAST(res.test_rst AS DECIMAL(10, 3))) OVER (\n--             PARTITION BY smp.provid_no, smp.sub_mat_no, res.smp_item\n--             ORDER BY TO_DATE(res.smp_date, 'YYYYMMDD')\n--             RANGE BETWEEN INTERVAL 7 DAYS PRECEDING AND INTERVAL 7 DAYS FOLLOWING\n--         ) > 5\n--         THEN TRUE\n--         ELSE FALSE\n--     END AS is_large_diff_stddev,\n--     -- 是否差距较大（超出标准范围）\n--     CASE \n--         WHEN CAST(res.test_rst AS DECIMAL(10, 3)) < CAST(res.test_min AS DECIMAL(10, 3)) \n--              OR CAST(res.test_rst AS DECIMAL(10, 3)) > CAST(res.test_max AS DECIMAL(10, 3))\n--         THEN TRUE\n--         ELSE FALSE\n--     END AS is_large_diff_range,\n--     -- 历史平均值（预留字段，待实现）\n--     NULL AS historical_avg_value,\n--     -- 与历史平均值的百分比差异（预留字段）\n--     NULL AS percent_diff_to_historical,\n--     -- 等级变化（与组内前一记录比较，待实现）\n--     NULL AS mat_std_change,\n--     CURRENT_TIMESTAMP() AS create_date_time, -- 创建时间\n--     CURRENT_TIMESTAMP() AS update_date_time -- 更新时间\n-- FROM\n-- dwi_qlt.dwi_qlt_tx_sampinfo_lz smp\n-- JOIN\n-- dwi_qlt.dwi_qlt_tx_analyresult_lz res\n-- ON\n--     smp.smp_no = res.smp_no\n-- WHERE\n--     ABS(DATEDIFF(TO_DATE(res.smp_date, 'YYYYMMDD'), TO_DATE(smp.get_smp_day, 'YYYYMMDD'))) <= 7; -- 筛选±7天内数据\n    \n\n    \n-- 方案二：只计算7天差值\n-- SELECT\n--     CONCAT(smp.smp_no, '_', res.smp_item) AS id, -- 主键\n--     smp.smp_no AS smp_no, -- 样品编号\n--     smp.heat_no AS heat_no, -- 炉次号\n--     smp.sub_mat_no AS sub_mat_no, -- 物料类别代码\n--     smp.provid_no AS provid_no, -- 供应商代码\n--     smp.get_smp_day AS get_smp_day, -- 取样日期\n--     res.smp_date AS smp_date, -- 检验日期\n--     smp.smp_type AS smp_type, -- 试样类型\n--     res.smp_item AS smp_item, -- 检验项目\n--     res.test_rst AS test_rst, -- 检验结果\n--     CAST(res.test_rst AS DECIMAL(10, 3)) AS test_rst_value, -- 检验结果数值（转换后，实际可能需要清洗）\n--     res.test_std_no AS test_std_no, -- 试验标准编号\n--     res.tester AS tester, -- 检验员\n--     res.test_eqt_no AS test_eqt_no, -- 检验设备\n--     smp.judg_rst AS judg_rst, -- 审核结果\n--     smp.note AS note, -- 备注\n--     DATEDIFF(TO_DATE(res.smp_date, 'YYYYMMDD'), TO_DATE(smp.get_smp_day, 'YYYYMMDD')) AS diff_days, -- 日期差值\n--     -- 高度相同逻辑：需根据实际业务实现UDF或窗口函数，此处仅示例\n--     FALSE AS is_high_similarity, -- 是否高度相同（±5%以内，待实现）\n--     -- 差距较大逻辑：需根据实际业务实现UDF或窗口函数，此处仅示例\n--     FALSE AS is_large_diff, -- 是否差距较大（超过±20%，待实现）\n--     CURRENT_TIMESTAMP() AS create_date_time, -- 创建时间\n--     CURRENT_TIMESTAMP() AS update_date_time -- 更新时间\n-- FROM\n-- dwi_qlt.dwi_qlt_tx_sampinfo_lz smp\n-- JOIN\n-- dwi_qlt.dwi_qlt_tx_analyresult_lz res\n-- ON\n--     smp.smp_no = res.smp_no\n-- WHERE\n--     ABS(DATEDIFF(TO_DATE(res.smp_date, 'YYYYMMDD'), TO_DATE(smp.get_smp_day, 'YYYYMMDD'))) <= 7; -- 筛选±7天内数据\n\n\n-- 方案三：明细\nDROP VIEW IF EXISTS  dwi_qlt.dwi_qlt_tx_sampinfo_lz_analysis_view;\nCREATE VIEW dwi_qlt.dwi_qlt_tx_sampinfo_lz_analysis_view AS \nSELECT * FROM dwi_qlt.dwi_qlt_tx_sampinfo_lz where ins_date>'20250601';\nDROP VIEW IF EXISTS  dwi_qlt.dwi_qlt_tx_analyresult_lz_analysis_view;\nCREATE VIEW dwi_qlt.dwi_qlt_tx_analyresult_lz_analysis_view AS \nSELECT * FROM dwi_qlt.dwi_qlt_tx_analyresult_lz where SMP_DATE>'20250701';\nTRUNCATE TABLE dwi_qlt.dwi_qlt_lz_supplier_metrics_analysis;\nINSERT OVERWRITE TABLE\n    dwi_qlt.dwi_qlt_lz_supplier_metrics_analysis\nSELECT\n    a.smp_no, -- 样品编号\n    a.provid_no, -- 供应商代码\n    a.sub_mat_no, -- 物料类别代码\n    a.get_smp_day, -- 取样日期\n    a.get_smp_time, -- 取样时间\n    a.smp_site_no, -- 取样地点代码\n    a.get_smp, -- 取样人\n    a.smp_sender, -- 送样人\n    a.smp_send_day, -- 送样日期\n    a.smp_send_time, -- 送样时间\n    b.smp_item, -- 检验项目\n    b.test_rst, -- 检验结果\n    b.smp_date, -- 检验日期\n    b.smp_time, -- 检验时间\n    b.tester, -- 检验员\n    b.test_eqt_no, -- 检验设备\n    a.note -- 备注\n    -- CURRENT_TIMESTAMP AS create_date_time, -- 创建时间\n    -- CURRENT_TIMESTAMP AS update_date_time, -- 修改时间\n    -- 0 AS status -- 状态(0可用_1不可用)\nFROM \ndwi_qlt.dwi_qlt_tx_analyresult_lz_analysis_view b\nLEFT JOIN\ndwi_qlt.dwi_qlt_tx_sampinfo_lz_analysis_view a\nON\n    a.smp_no = b.smp_no;\n",
	"currentDatabase":"dwi_qlt",
	"description":"",
	"directory":"/廉政专项/检化验/宽表",
	"name":"etl_dwi_qlt_lz_supplier_metrics_analysis",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}