{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: （1）智慧运营中心部分数据概览-采购合同明细\n-- soc_overview_procurementcontract\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_prc.dwi_prc_lz_soc_overview_procurementcontract;\n-- CREATE TABLE\n--     dwi_prc.dwi_prc_lz_soc_overview_procurementcontract (\n-- \t\tkey string COMMENT '键',\n-- \t\thtzs string COMMENT '合同总数',\n-- \t\tdzht string COMMENT '电子合同',\n-- \t\trank string COMMENT 'rank',\n-- \t\tetl_date DATE COMMENT 'ETL时间'\n--     )\n-- COMMENT '廉政八项-智慧运营中心-采购合同明细'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\nINSERT OVERWRITE TABLE\n\tdwi_prc.dwi_prc_lz_soc_overview_procurementcontract PARTITION(mt= '202507')\n\t-- sql: -年度采购合同数 key-键 htzs-合同总数 dzht-电子合同\nSELECT\n\tt1.key,\n    t1.value AS htzs,\n    t2.value AS dzht,\n    CASE \n        COALESCE(t1.key, t2.key)\n        WHEN '铁矿石' THEN '1'\n        WHEN '煤炭' THEN '2'\n        WHEN '焦炭' THEN '3'\n        WHEN '废钢' THEN '4'\n        WHEN '熔剂' THEN '5'\n        WHEN '合金' THEN '6'\n        WHEN '备件' THEN '7'\n        WHEN '设备' THEN '8'\n        WHEN '辅材' THEN '9'\n        ELSE NULL\n    END AS rank,\n    CURRENT_DATE()                -- 当前日期\nFROM\n\t(\n\t\tSELECT\n\t\t\tt.type AS key,\n\t\t\tCOUNT(1) AS value\n\t\tFROM\n\t\t\t(\n\t\t\t\tSELECT\n\t\t\t\t\tCASE\n\t\t\t\t\t\tWHEN a.pocode = 'U' THEN '备件'\n\t\t\t\t\t\tWHEN a.pocode IN ('G', 'Q') THEN '设备'\n\t\t\t\t\t\tWHEN a.pocode = 'L' THEN '辅材'\n\t\t\t\t\t\tWHEN m.chapter IN ('A', 'B') THEN '煤炭'\n\t\t\t\t\t\tWHEN m.chapter IN ('C') THEN '焦炭'\n\t\t\t\t\t\tWHEN m.chapter IN ('D', 'E') THEN '铁矿石'\n\t\t\t\t\t\tWHEN m.chapter IN ('H') THEN '废钢'\n\t\t\t\t\t\tWHEN m.chapter IN ('F') THEN '熔剂'\n\t\t\t\t\t\tWHEN m.chapter IN ('G') THEN '合金'\n\t\t\t\t\t\tELSE '其他'\n\t\t\t\t\tEND AS TYPE,\n\t\t\t\t\ta.pono\n\t\t\t\tFROM\n\t\t\t\t\tdwi_prc.dwi_prc_tbmpv030 a\n\t\t\t\t\tJOIN dwi_prc.dwi_prc_tbmpv031 b ON (\n\t\t\t\t\t\ta.compid = b.compid\n\t\t\t\t\t\tAND a.pono = b.pono\n\t\t\t\t\t)\n\t\t\t\t\tLEFT JOIN dwi_log.dwi_log_tbmrmtrl m ON (\n\t\t\t\t\t\tb.matrlno = m.mtrlno\n\t\t\t\t\t\tAND a.compid = m.compid\n\t\t\t\t\t)\n\t\t\t\tWHERE\n\t\t\t\t\ta.pocode IN ('N', 'P', 'S', 'F', 'H', 'D', 'U', 'G', 'Q', 'L')\n\t\t\t\t\tAND a.stus IN ('N', 'X')\n\t\t\t\t\tAND a.postyle = 'A'\n\t\t\t\t\tAND CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(), 'yyyyMMdd') AS STRING) BETWEEN a.startdate AND a.enddate\n\t\t\t\t-- \tto_char (NOW() AT time zone 'HongKong', 'YYYYMMDD') BETWEEN a.startdate AND a.enddate\n\t\t\t\tGROUP BY\n\t\t\t\t\tCASE\n\t\t\t\t\t\tWHEN a.pocode = 'U' THEN '备件'\n\t\t\t\t\t\tWHEN a.pocode IN ('G', 'Q') THEN '设备'\n\t\t\t\t\t\tWHEN a.pocode = 'L' THEN '辅材'\n\t\t\t\t\t\tWHEN m.chapter IN ('A', 'B') THEN '煤炭'\n\t\t\t\t\t\tWHEN m.chapter IN ('C') THEN '焦炭'\n\t\t\t\t\t\tWHEN m.chapter IN ('D', 'E') THEN '铁矿石'\n\t\t\t\t\t\tWHEN m.chapter IN ('H') THEN '废钢'\n\t\t\t\t\t\tWHEN m.chapter IN ('F') THEN '熔剂'\n\t\t\t\t\t\tWHEN m.chapter IN ('G') THEN '合金'\n\t\t\t\t\t\tELSE '其他'\n\t\t\t\t\tEND,\n\t\t\t\t\ta.pono\n\t\t\t) t\n\t\tWHERE\n\t\t\tt.type != '其他'\n\t\tGROUP BY\n\t\t\tt.type\n\t) t1\n\tFULL JOIN (\n\t\tSELECT\n\t\t\tt.type AS key,\n\t\t\tt.pononum AS value\n\t\tFROM\n\t\t\t(\n\t\t\t\tSELECT\n\t\t\t\t\ta1.type,\n\t\t\t\t\tSUM(a1.num) AS pononum\n\t\t\t\tFROM\n\t\t\t\t\t(\n\t\t\t\t\t\tSELECT\n\t\t\t\t\t\t\tCASE\n\t\t\t\t\t\t\t\tWHEN b.pocode IN ('G', 'Q') THEN '设备'\n\t\t\t\t\t\t\t\tWHEN b.pocode = 'L' THEN '辅材'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('A', 'B') THEN '煤炭'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('C') THEN '焦炭'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('D', 'E') THEN '铁矿石'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('H') THEN '废钢'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('F') THEN '熔剂'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('G') THEN '合金'\n\t\t\t\t\t\t\t\tELSE '其他'\n\t\t\t\t\t\t\tEND AS TYPE,\n\t\t\t\t\t\t\tb.pono,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\tCASE\n\t\t\t\t\t\t\t\t\tWHEN (\n\t\t\t\t\t\t\t\t\t\tb.purMode NOT IN ('A13', 'A14', 'A15')\n\t\t\t\t\t\t\t\t\t\tAND a.isonline = 'Y'\n\t\t\t\t\t\t\t\t\t) THEN 1\n\t\t\t\t\t\t\t\t\tWHEN (\n\t\t\t\t\t\t\t\t\t\tb.purMode IN ('A13', 'A14', 'A15')\n\t\t\t\t\t\t\t\t\t\tAND b.mroorder != ''\n\t\t\t\t\t\t\t\t\t) THEN 1\n\t\t\t\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t\t) AS num\n\t\t\t\t\t\tFROM\n\t\t\t\t\t\t\tdwi_prc.dwi_prc_tbmpv030 b\n\t\t\t\t\t\t\tJOIN dwi_prc.dwi_prc_tbmpv031 b1 ON (\n\t\t\t\t\t\t\t\tb.compid = b1.compid\n\t\t\t\t\t\t\t\tAND b.pono = b1.pono\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tLEFT JOIN dwi_log.dwi_log_tbmrmtrl m ON (\n\t\t\t\t\t\t\t\tb1.matrlno = m.mtrlno\n\t\t\t\t\t\t\t\tAND b.compid = m.compid\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tLEFT JOIN dwi_prc.dwi_prc_tbct03c_lz a ON a.CONTNO = b.PONO\n\t\t\t\t\t\tWHERE\n\t\t\t\t\t\t\tb.pocode IN ('G', 'Q', 'L', 'N', 'P', 'S', 'F', 'H', 'D')\n\t\t\t\t\t\t\tAND b.stus IN ('N', 'X')\n\t\t\t\t\t\t\tAND b.postyle = 'A'\n\t\t\t\t\t\t\tAND CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(), 'yyyyMMdd') AS STRING) BETWEEN b.startDate AND b.enddate\n\t\t\t\t-- \t\t\tto_char (NOW() AT time zone 'HongKong', 'YYYYMMDD') BETWEEN b.startDate AND b.enddate\n\t\t\t\t\t\tGROUP BY\n\t\t\t\t\t\t\tCASE\n\t\t\t\t\t\t\t\tWHEN b.pocode IN ('G', 'Q') THEN '设备'\n\t\t\t\t\t\t\t\tWHEN b.pocode = 'L' THEN '辅材'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('A', 'B') THEN '煤炭'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('C') THEN '焦炭'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('D', 'E') THEN '铁矿石'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('H') THEN '废钢'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('F') THEN '熔剂'\n\t\t\t\t\t\t\t\tWHEN m.chapter IN ('G') THEN '合金'\n\t\t\t\t\t\t\t\tELSE '其他'\n\t\t\t\t\t\t\tEND,\n\t\t\t\t\t\t\tb.pono,\n\t\t\t\t\t\t\tb.purMode,\n\t\t\t\t\t\t\tb.mroorder,\n\t\t\t\t\t\t\ta.isonline\n\t\t\t\t\t) a1\n\t\t\t\tWHERE\n\t\t\t\t\ta1.num != 0\n\t\t\t\tGROUP BY\n\t\t\t\t\ta1.type\n\t\t\t\tUNION\n\t\t\t\tSELECT\n\t\t\t\t\tb1.type,\n\t\t\t\t\tSUM(b1.num) AS pononum\n\t\t\t\tFROM\n\t\t\t\t\t(\n\t\t\t\t\t\tSELECT\n\t\t\t\t\t\t\t'备件' AS TYPE,\n\t\t\t\t\t\t\ta.pono,\n\t\t\t\t\t\t\tCASE\n\t\t\t\t\t\t\t\tWHEN a.purmode IN ('A13', 'A14', 'A15')\n\t\t\t\t\t\t\t\tAND a.mroorder != '' THEN 1\n\t\t\t\t\t\t\t\tWHEN b.isonline = 'Y' THEN 1\n\t\t\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\t\tEND AS num\n\t\t\t\t\t\tFROM\n\t\t\t\t\t\t\tdwi_prc.dwi_prc_tbmpv030 a\n\t\t\t\t\t\t\tLEFT JOIN dwi_prc.dwi_prc_tbct03c_lz b ON b.CONTNO = a.PONO\n\t\t\t\t\t\t\tAND b.CONTVERSION = '00'\n\t\t\t\t\t\tWHERE\n\t\t\t\t\t\t\ta.pocode = 'U'\n\t\t\t\t\t\t\tAND a.postyle = 'A'\n\t\t\t\t\t\t\tAND (\n\t\t\t\t\t\t\t\ta.ctrlType = ''\n\t\t\t\t\t\t\t\tOR a.ctrlType IS NULL\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tAND a.stus IN ('N', 'X')\n\t\t\t\t\t\t\tAND CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(), 'yyyyMMdd') AS STRING) BETWEEN a.startDate AND a.endDate\n\t\t\t\t-- \t\t\tto_char (NOW() AT time zone 'HongKong', 'YYYYMMDD') BETWEEN a.startDate AND a.enddate\n\t\t\t\t\t) AS b1\n\t\t\t\tWHERE\n\t\t\t\t\tb1.num != 0\n\t\t\t\tGROUP BY\n\t\t\t\t\tb1.type\n\t\t\t) t\n\t\tWHERE\n\t\t\tt.type != '其他'\n\t) t2 ON t1.key = t2.key;",
	"currentDatabase":"dwi_log",
	"description":"",
	"directory":"/廉政专项/智慧运营/明细表",
	"name":"etl_dwi_lz_soc_overview_procurementcontract",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}