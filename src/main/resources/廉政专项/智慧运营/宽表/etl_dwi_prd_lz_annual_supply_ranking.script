{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-智慧运营中心-年度供货量排名\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_prd.dwi_prd_lz_annual_supply_ranking;\n-- CREATE TABLE\n--     dwi_prd.dwi_prd_lz_annual_supply_ranking (\n--     type VARCHAR(500),\n--     key_name VARCHAR(500),\n--     value VARCHAR(500),\n--     typerank VARCHAR(500)\n--     )\n-- COMMENT '廉政八项-智慧运营中心-年度供货量排名'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\nINSERT OVERWRITE TABLE\n\tdwi_prd.dwi_prd_lz_annual_supply_ranking PARTITION (mt = '202507')\nSELECT\n         typename                                   AS type\n       , vendorname                                 AS key_name\n       , 年度采购量                                      AS value\n       , DENSE_RANK() OVER (ORDER BY typename DESC) AS typerank\nFROM\n         (\n                  SELECT\n                           tt.*\n                  FROM\n                           (\n                                     SELECT\n                                               SUBSTR(c.inspDate, 1, 4) AS year\n                                             , CASE\n                                                         WHEN e.chapter IN ('A'\n                                                                          , 'B')\n                                                                   THEN '煤炭'\n                                                         WHEN e.chapter IN ('C')\n                                                                   THEN '焦炭'\n                                                         WHEN e.chapter IN ('D'\n                                                                          , 'E')\n                                                                   THEN '铁矿石'\n                                                         WHEN e.chapter IN ('H')\n                                                                   THEN '废钢'\n                                                         WHEN e.chapter IN ('F')\n                                                                   THEN '熔剂'\n                                                         WHEN e.chapter IN ('G')\n                                                                   THEN '合金'\n                                                                   ELSE '其他'\n                                               END AS typeName\n                                             , a.vendorno\n                                             , a.vendorname\n                                             , CAST(SUM(d.INSPQTY)/10000 AS DECIMAL(16,2)) AS 年度采购量\n                                     FROM\n                                               dwi_prc.dwi_prc_tbmpv030  a\n                                               JOIN\n                                                         dwi_prc.dwi_prc_tbmpv031 b\n                                                         ON\n                                                                   a.compid   = b.compid\n                                                                   AND a.pono = b.pono\n                                               JOIN\n                                                         dwi_log.dwi_log_tbmrmtrl e\n                                                         ON\n                                                                   b.matrlno    = e.mtrlno\n                                                                   AND a.compid = e.compid\n                                               LEFT JOIN\n                                                         dwi_log.dwi_log_tbmpv040 c\n                                                         ON\n                                                                   a.compId   = b.compId\n                                                                   AND b.pono = c.pono\n                                               LEFT JOIN\n                                                         dwi_log.dwi_log_tbmpv041 d\n                                                         ON\n                                                                   a.compid       = d.compid\n                                                                   AND a.pono     = d.pono\n                                                                   AND c.inspno   = d.inspno\n                                                                   AND b.poitemno = d.poitemno\n                                     WHERE\n                                               a.pocode IN ('N'\n                                                          , 'P'\n                                                          , 'S'\n                                                          , 'F'\n                                                          , 'H'\n                                                          , 'D')\n                                               AND a.stus IN ('N'\n                                                            , 'X')\n                                               AND a.postyle                = 'A'\n                                               AND c.stus                   = 'Y'\n                                               AND SUBSTR(c.inspDate, 1, 4) = SUBSTR(current_date(), 1, 4)\n                                               AND a.vendorno NOT IN ('NJ0121'\n                                                                    , 'JS0026'\n                                                                    , 'NJ0013'\n                                                                    , 'NJ4898'\n                                                                    , 'NJ4200'\n                                                                    , 'JS6773'\n                                                                    , 'NJ5146')\n                                     GROUP BY\n                                               SUBSTR(c.inspDate, 1, 4)\n                                             , a.vendorno\n                                             , a.vendorname\n                                             , CASE\n                                                         WHEN e.chapter IN ('A'\n                                                                          , 'B')\n                                                                   THEN '煤炭'\n                                                         WHEN e.chapter IN ('C')\n                                                                   THEN '焦炭'\n                                                         WHEN e.chapter IN ('D'\n                                                                          , 'E')\n                                                                   THEN '铁矿石'\n                                                         WHEN e.chapter IN ('H')\n                                                                   THEN '废钢'\n                                                         WHEN e.chapter IN ('F')\n                                                                   THEN '熔剂'\n                                                         WHEN e.chapter IN ('G')\n                                                                   THEN '合金'\n                                                                   ELSE '其他'\n                                               END\n                                     ORDER BY\n                                               SUM(d.INSPQTY) DESC\n                           )\n                           AS tt\n                  WHERE\n                           tt.typeName != '其他'\n                  ORDER BY\n                           typename\n                         , 年度采购量 DESC\n         )\n         x\nWHERE\n         vendorname    IS NOT NULL\n         AND LENGTH(vendorname) != 0\n;",
	"currentDatabase":"dwi_eqp",
	"description":"",
	"directory":"/廉政专项/智慧运营/宽表",
	"name":"etl_dwi_prd_lz_annual_supply_ranking",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}