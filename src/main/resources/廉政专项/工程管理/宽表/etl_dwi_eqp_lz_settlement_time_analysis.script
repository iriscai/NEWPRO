{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-工程项目-工程结算时间异常分析\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_eqp.dwi_eqp_lz_settlement_time_analysis;\n-- CREATE TABLE\n--     dwi_eqp.dwi_eqp_lz_settlement_time_analysis (\n--     -- 基本标识信息\n--     CONTRACT_NUMBER VARCHAR(200) COMMENT '合同编号',\n--     PROJECT_CODE VARCHAR(200) COMMENT '立项号',\n--     BILL_NUMBER VARCHAR(200) COMMENT '预结算编号',\n    \n--     -- 项目基本信息\n--     PROJECT_NAME VARCHAR(200) COMMENT '工程名称',\n--     CONTRACT_NAME VARCHAR(200) COMMENT '所属项目名称',\n--     CONTRACT_TYPE VARCHAR(200) COMMENT '合同类型',\n    \n--     -- 组织信息\n--     BRANCHFACTORY_CODE VARCHAR(200) COMMENT '建设单位编码',\n--     BRANCHFACTORY_NAME VARCHAR(200) COMMENT '建设单位名称',\n--     GENERALFACTORY_CODE VARCHAR(200) COMMENT '事业部编码',\n--     GENERALFACTORY_NAME VARCHAR(200) COMMENT '事业部名称',\n--     COMPANY_CODE VARCHAR(200) COMMENT '施工单位编号/客商编号',\n--     COMPANY_NAME VARCHAR(200) COMMENT '施工单位名称/客商名称',\n    \n--     -- 合同时间信息\n--     BILL_DATETIME VARCHAR(200) COMMENT '单据日期(合同)',\n--     PLAN_START_DATETIME VARCHAR(200) COMMENT '计划开始时间',\n--     PLAN_END_DATETIME VARCHAR(200) COMMENT '计划完成时间',\n    \n--     -- 结算时间信息\n--     SETTLEMENT_BILL_DATETIME VARCHAR(200) COMMENT '单据发起日期(结算)',\n--     CREATE_DATETIME VARCHAR(200) COMMENT '创建时间',\n--     UPDATE_DATETIME VARCHAR(200) COMMENT '最后修改/删除时间',\n    \n--     -- 结算资料提交情况\n--     VSIA_NUMBER DECIMAL(32,6) COMMENT '现场签证',\n--     COST_SHEET_NUMBER DECIMAL(32,6) COMMENT '核价单',\n--     STATEMENT_OF_ACCOUNT_NUMBER VARCHAR(200) COMMENT '工程量计算书',\n--     DESIGN_CHANGE_NUMBER DECIMAL(32,6) COMMENT '设计变更',\n--     COMPLETED_NUMBER DECIMAL(32,6) COMMENT '竣工验收单',\n--     DEBUG_NUMBER DECIMAL(32,6) COMMENT '调试报告',\n--     CATALOG VARCHAR(200) COMMENT '竣工图目录',\n--     DETAIL VARCHAR(200) COMMENT '甲方供应材料、机具清单',\n    \n--     -- 结算金额信息\n--     CONTRACT_PRICE DECIMAL(32,6) COMMENT '合同金额',\n--     PLAN_PRICE DECIMAL(32,6) COMMENT '送审金额',\n--     ACTUAL_PRICE DECIMAL(32,6) COMMENT '审定金额',\n--     WITHHOLD_PRICE DECIMAL(32,6) COMMENT '扣款金额',\n--     SETTLE_PRICE DECIMAL(32,6) COMMENT '结算金额',\n    \n--     -- 审批信息\n--     APPROVAL_DESCR VARCHAR(200) COMMENT '战略运营部审批说明',\n--     WITHHOLD_DESCR VARCHAR(200) COMMENT '合同扣款条款执行说明',\n--     BILL_STATUS DECIMAL(32,6) COMMENT '单据状态',\n    \n--     -- 时间计算字段\n--     SETTLEMENT_DELAY_DAYS DECIMAL(32,6) COMMENT '结算延迟天数(单据发起日期-计划完成时间)',\n--     APPROVAL_DURATION_DAYS DECIMAL(32,6) COMMENT '结算审批持续时间(更新时间-单据发起日期)',\n    \n--     -- 金额计算字段\n--     SETTLEMENT_CONTRACT_DIFF DECIMAL(32,6) COMMENT '结算金额与合同金额差异',\n--     SETTLEMENT_CONTRACT_DIFF_PERCENT DECIMAL(32,6) COMMENT '结算金额与合同金额差异百分比',\n--     PLAN_ACTUAL_DIFF DECIMAL(32,6) COMMENT '送审金额与审定金额差异',\n--     PLAN_ACTUAL_DIFF_PERCENT DECIMAL(32,6) COMMENT '送审金额与审定金额差异百分比',\n    \n--     -- 异常标记字段\n--     IS_SETTLEMENT_DELAY VARCHAR(200) COMMENT '结算是否延迟(Y/N)',\n--     IS_APPROVAL_ABNORMAL VARCHAR(200) COMMENT '审批时间是否异常(Y/N)',\n--     IS_DOCUMENT_INCOMPLETE VARCHAR(200) COMMENT '结算资料是否不完整(Y/N)',\n--     IS_AMOUNT_ABNORMAL VARCHAR(200) COMMENT '结算金额是否异常(Y/N)',\n    \n--     -- 系统字段\n--     ETL_DATE VARCHAR(200) COMMENT 'ETL处理日期',\n--     UPDATE_TIME VARCHAR(200) COMMENT '更新时间'\n--     )\n-- COMMENT '廉政八项-工程项目-工程结算时间异常分析'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\n\n\n-- 创建工程结算时间异常分析宽表视图\nINSERT OVERWRITE TABLE\n\tdwi_eqp.dwi_eqp_lz_settlement_time_analysis PARTITION (mt = '202506')\nSELECT \n    -- 基本标识信息\n    c.CONTRACT_NUMBER,                                      -- 合同编号\n    c.PROJECT_CODE,                                         -- 立项号\n    s.BILL_NUMBER,                                          -- 预结算编号\n    \n    -- 项目基本信息\n    c.PROJECT_NAME,                                         -- 工程名称\n    c.CONTRACT_NAME,                                        -- 所属项目名称\n    c.CONTRACT_TYPE,                                        -- 合同类型\n    \n    -- 组织信息\n    c.BRANCHFACTORY_CODE,                                   -- 建设单位编码\n    c.BRANCHFACTORY_NAME,                                   -- 建设单位名称\n    c.GENERALFACTORY_CODE,                                  -- 事业部编码\n    c.GENERALFACTORY_NAME,                                  -- 事业部名称\n    s.COMPANY_CODE,                                         -- 施工单位编号\n    s.COMPANY_NAME,                                         -- 施工单位名称\n    \n    -- 合同时间信息\n    c.BILL_DATETIME,                                        -- 单据日期(合同)\n    c.PLAN_START_DATETIME,                                  -- 计划开始时间\n    c.PLAN_END_DATETIME,                                    -- 计划完成时间\n    \n    -- 结算时间信息\n    s.BILL_DATETIME AS SETTLEMENT_BILL_DATETIME,            -- 单据发起日期(结算)\n    s.CREATE_DATETIME,                                      -- 创建时间\n    s.UPDATE_DATETIME,                                      -- 最后修改/删除时间\n    \n    -- 结算资料提交情况\n    s.VSIA_NUMBER,                                          -- 现场签证\n    s.COST_SHEET_NUMBER,                                    -- 核价单\n    s.STATEMENT_OF_ACCOUNT_NUMBER,                          -- 工程量计算书\n    s.DESIGN_CHANGE_NUMBER,                                 -- 设计变更\n    s.COMPLETED_NUMBER,                                     -- 竣工验收单\n    s.DEBUG_NUMBER,                                         -- 调试报告\n    s.CATALOG,                                              -- 竣工图目录\n    s.DETAIL,                                               -- 甲方供应材料、机具清单\n    \n    -- 结算金额信息\n    c.CONTRACT_PRICE,                                       -- 合同金额\n    s.PLAN_PRICE,                                           -- 送审金额\n    s.ACTUAL_PRICE,                                         -- 审定金额\n    s.WITHHOLD_PRICE,                                       -- 扣款金额\n    s.SETTLE_PRICE,                                         -- 结算金额\n    \n    -- 审批信息\n    s.APPROVAL_DESCR,                                       -- 战略运营部审批说明\n    s.WITHHOLD_DESCR,                                       -- 合同扣款条款执行说明\n    s.BILL_STATUS,                                          -- 单据状态\n    \n    -- 时间计算字段\n    CASE \n        WHEN s.BILL_DATETIME IS NOT NULL AND c.PLAN_END_DATETIME IS NOT NULL \n        THEN DATEDIFF(s.BILL_DATETIME, c.PLAN_END_DATETIME)\n        ELSE NULL\n    END AS SETTLEMENT_DELAY_DAYS,                           -- 结算延迟天数\n    \n    CASE \n        WHEN s.UPDATE_DATETIME IS NOT NULL AND s.BILL_DATETIME IS NOT NULL \n        THEN DATEDIFF(s.UPDATE_DATETIME, s.BILL_DATETIME)\n        ELSE NULL\n    END AS APPROVAL_DURATION_DAYS,                          -- 结算审批持续时间\n    \n    -- 金额计算字段\n    COALESCE(s.SETTLE_PRICE, 0) - COALESCE(c.CONTRACT_PRICE, 0) AS SETTLEMENT_CONTRACT_DIFF,  -- 结算金额与合同金额差异\n    \n    CASE \n        WHEN c.CONTRACT_PRICE IS NOT NULL AND c.CONTRACT_PRICE != 0 \n        THEN (COALESCE(s.SETTLE_PRICE, 0) - c.CONTRACT_PRICE) / c.CONTRACT_PRICE * 100\n        ELSE NULL\n    END AS SETTLEMENT_CONTRACT_DIFF_PERCENT,                -- 结算金额与合同金额差异百分比\n    \n    COALESCE(s.PLAN_PRICE, 0) - COALESCE(s.ACTUAL_PRICE, 0) AS PLAN_ACTUAL_DIFF,  -- 送审金额与审定金额差异\n    \n    CASE \n        WHEN s.PLAN_PRICE IS NOT NULL AND s.PLAN_PRICE != 0 \n        THEN (COALESCE(s.PLAN_PRICE, 0) - COALESCE(s.ACTUAL_PRICE, 0)) / s.PLAN_PRICE * 100\n        ELSE NULL\n    END AS PLAN_ACTUAL_DIFF_PERCENT,                        -- 送审金额与审定金额差异百分比\n    \n    -- 异常标记字段\n    CASE \n        WHEN s.BILL_DATETIME IS NOT NULL AND c.PLAN_END_DATETIME IS NOT NULL \n             AND DATEDIFF(s.BILL_DATETIME, c.PLAN_END_DATETIME) > 30\n        THEN 'Y'\n        ELSE 'N'\n    END AS IS_SETTLEMENT_DELAY,                             -- 结算是否延迟(超过30天)\n    \n    CASE \n        WHEN s.UPDATE_DATETIME IS NOT NULL AND s.BILL_DATETIME IS NOT NULL \n             AND DATEDIFF(s.UPDATE_DATETIME, s.BILL_DATETIME) > 60\n        THEN 'Y'\n        ELSE 'N'\n    END AS IS_APPROVAL_ABNORMAL,                            -- 审批时间是否异常(超过60天)\n    \n    CASE \n        WHEN (s.COMPLETED_NUMBER IS NULL OR s.COMPLETED_NUMBER = 0)\n             OR (s.STATEMENT_OF_ACCOUNT_NUMBER IS NULL OR s.STATEMENT_OF_ACCOUNT_NUMBER = '')\n             OR (s.CATALOG IS NULL OR s.CATALOG = '')\n        THEN 'Y'\n        ELSE 'N'\n    END AS IS_DOCUMENT_INCOMPLETE,                          -- 结算资料是否不完整\n    \n    CASE \n        WHEN c.CONTRACT_PRICE IS NOT NULL AND s.SETTLE_PRICE IS NOT NULL\n             AND ABS((s.SETTLE_PRICE - c.CONTRACT_PRICE) / c.CONTRACT_PRICE) > 0.2\n        THEN 'Y'\n        ELSE 'N'\n    END AS IS_AMOUNT_ABNORMAL,                              -- 结算金额是否异常(与合同金额差异超过20%)\n    \n    -- 系统字段\n    CURRENT_DATE() AS ETL_DATE,                          -- ETL处理日期\n    CURRENT_DATE() AS UPDATE_TIME                        -- 更新时间\n    \nFROM \n    dwi_eqp.dwi_eqp_jd_cbm_contract_lz\t c                                       -- 合同信息表\nJOIN \n    dwi_eqp.dwi_eqp_jd_cbm_settlement_lz s                                     -- 预结算主表\n    ON c.CONTRACT_NUMBER = s.CONTRACT_NUMBER AND c.PROJECT_CODE = s.PROJECT_CODE;\n\n",
	"currentDatabase":"dwi_eqp",
	"description":"",
	"directory":"/廉政专项/工程管理/宽表",
	"name":"etl_dwi_eqp_lz_settlement_time_analysis",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}