{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-工程项目-甲供材领用使用分析\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_eqp.dwi_eqp_lz_material_supply_analysis;\n-- CREATE TABLE\n--     dwi_eqp.dwi_eqp_lz_material_supply_analysis (\n--     -- 基本标识信息\n--     CONTRACT_NUMBER VARCHAR(200) COMMENT '合同编号',\n--     PROJECT_CODE VARCHAR(200) COMMENT '立项号',\n--     BILL_NUMBER VARCHAR(200) COMMENT '预结算编号',\n    \n--     -- 项目基本信息\n--     PROJECT_NAME VARCHAR(200) COMMENT '工程名称',\n--     CONTRACT_NAME VARCHAR(200) COMMENT '所属项目名称',\n--     CONTRACT_TYPE VARCHAR(200) COMMENT '合同类型',\n    \n--     -- 组织信息\n--     BRANCHFACTORY_CODE VARCHAR(200) COMMENT '建设单位编码',\n--     BRANCHFACTORY_NAME VARCHAR(200) COMMENT '建设单位名称',\n--     GENERALFACTORY_CODE VARCHAR(200) COMMENT '事业部编码',\n--     GENERALFACTORY_NAME VARCHAR(200) COMMENT '事业部名称',\n--     COMPANY_CODE VARCHAR(200) COMMENT '施工单位编号/客商编号',\n--     COMPANY_NAME VARCHAR(200) COMMENT '施工单位名称/客商名称',\n    \n--     -- 合同时间信息\n--     BILL_DATETIME VARCHAR(200) COMMENT '单据日期(合同)',\n--     PLAN_START_DATETIME VARCHAR(200) COMMENT '计划开始时间',\n--     PLAN_END_DATETIME VARCHAR(200) COMMENT '计划完成时间',\n    \n--     -- 结算时间信息\n--     SETTLEMENT_BILL_DATETIME VARCHAR(200) COMMENT '单据发起日期(结算)',\n--     CREATE_DATETIME VARCHAR(200) COMMENT '创建时间',\n--     UPDATE_DATETIME VARCHAR(200) COMMENT '最后修改/删除时间',\n    \n--     -- 结算资料提交情况\n--     VSIA_NUMBER DECIMAL(32,6) COMMENT '现场签证',\n--     COST_SHEET_NUMBER DECIMAL(32,6) COMMENT '核价单',\n--     STATEMENT_OF_ACCOUNT_NUMBER VARCHAR(200) COMMENT '工程量计算书',\n--     DESIGN_CHANGE_NUMBER DECIMAL(32,6) COMMENT '设计变更',\n--     COMPLETED_NUMBER DECIMAL(32,6) COMMENT '竣工验收单',\n--     DEBUG_NUMBER DECIMAL(32,6) COMMENT '调试报告',\n--     CATALOG VARCHAR(200) COMMENT '竣工图目录',\n--     DETAIL VARCHAR(200) COMMENT '甲方供应材料、机具清单',\n    \n--     -- 结算金额信息\n--     CONTRACT_PRICE DECIMAL(32,6) COMMENT '合同金额',\n--     PLAN_PRICE DECIMAL(32,6) COMMENT '送审金额',\n--     ACTUAL_PRICE DECIMAL(32,6) COMMENT '审定金额',\n--     WITHHOLD_PRICE DECIMAL(32,6) COMMENT '扣款金额',\n--     SETTLE_PRICE DECIMAL(32,6) COMMENT '结算金额',\n    \n--     -- 审批信息\n--     APPROVAL_DESCR VARCHAR(200) COMMENT '战略运营部审批说明',\n--     WITHHOLD_DESCR VARCHAR(200) COMMENT '合同扣款条款执行说明',\n--     BILL_STATUS DECIMAL(32,6) COMMENT '单据状态',\n    \n--     -- 时间计算字段\n--     SETTLEMENT_DELAY_DAYS DECIMAL(32,6) COMMENT '结算延迟天数(单据发起日期-计划完成时间)',\n--     APPROVAL_DURATION_DAYS DECIMAL(32,6) COMMENT '结算审批持续时间(更新时间-单据发起日期)',\n    \n--     -- 金额计算字段\n--     SETTLEMENT_CONTRACT_DIFF DECIMAL(32,6) COMMENT '结算金额与合同金额差异',\n--     SETTLEMENT_CONTRACT_DIFF_PERCENT DECIMAL(32,6) COMMENT '结算金额与合同金额差异百分比',\n--     PLAN_ACTUAL_DIFF DECIMAL(32,6) COMMENT '送审金额与审定金额差异',\n--     PLAN_ACTUAL_DIFF_PERCENT DECIMAL(32,6) COMMENT '送审金额与审定金额差异百分比',\n    \n--     -- 异常标记字段\n--     IS_SETTLEMENT_DELAY VARCHAR(200) COMMENT '结算是否延迟(Y/N)',\n--     IS_APPROVAL_ABNORMAL VARCHAR(200) COMMENT '审批时间是否异常(Y/N)',\n--     IS_DOCUMENT_INCOMPLETE VARCHAR(200) COMMENT '结算资料是否不完整(Y/N)',\n--     IS_AMOUNT_ABNORMAL VARCHAR(200) COMMENT '结算金额是否异常(Y/N)',\n    \n--     -- 系统字段\n--     ETL_DATE VARCHAR(200) COMMENT 'ETL处理日期',\n--     UPDATE_TIME VARCHAR(200) COMMENT '更新时间'\n--     )\n-- COMMENT '廉政八项-工程项目-甲供材领用使用分析'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\n-- 创建甲供材领用使用分析宽表视图\nCREATE OR REPLACE VIEW dwi_eqp.v_material_supply_analysis AS\nSELECT \n    ROW_NUMBER() OVER(ORDER BY c.CONTRACT_NUMBER, c.MATRL_NO) AS ID,\n    \n    -- 关联标识字段\n    c.CONTRACT_NUMBER,\n    c.MATRL_NO,\n    m.FMATCODE,\n    \n    -- 合同甲供材信息\n    c.CNM_DESC,\n    c.UNIT_INV,\n    c.ISSUE_QTY,\n    c.ISSUE_PRICE,\n    c.ISSUE_AMT,\n    \n    -- 预结算材料信息\n    m.FMATNAME,\n    m.FMATUNIT,\n    m.FSUMAMOUNT,\n    m.FPRICE,\n    \n    -- 材料分类信息\n    m.FJASUPPLYFROM,\n    m.FJASUPPLYCLASS0,\n    m.FJASUPPLYCLASS1,\n    m.FJASUPPLYCLASS2,\n    m.FJASUPPLYCLASS3,\n    \n    -- 领用人信息\n    m.CREATE_USER_NAME,\n    m.CREATE_TIME,\n    m.FMATMEMO,\n    \n    -- 对比分析字段\n    NVL(m.FSUMAMOUNT, 0) - NVL(c.ISSUE_QTY, 0) AS USAGE_DIFF,\n    CASE \n        WHEN c.ISSUE_QTY IS NOT NULL AND c.ISSUE_QTY <> 0 \n        THEN m.FSUMAMOUNT / c.ISSUE_QTY \n        ELSE NULL \n    END AS USAGE_RATIO,\n    CASE \n        WHEN NVL(m.FSUMAMOUNT, 0) > NVL(c.ISSUE_QTY, 0) \n        THEN 1 \n        ELSE 0 \n    END AS IS_OVER_USAGE,\n    \n    -- 系统字段\n    CURRENT_DATE AS ETL_DATE\n    \nFROM \n    CONTRACT_MATERIAL c\nLEFT JOIN \n    TYSPF_MATERIAL m ON c.MATRL_NO = m.FMATCODE\nWHERE \n    m.FJASUPPLY = 1  -- 只关联甲供材料\n\nUNION ALL\n\n-- 包含在预结算中有但合同中没有的甲供材\nSELECT \n    ROW_NUMBER() OVER(ORDER BY m.FMATCODE) + \n    (SELECT COUNT(*) FROM CONTRACT_MATERIAL c \n     JOIN TYSPF_MATERIAL m2 ON c.MATRL_NO = m2.FMATCODE WHERE m2.FJASUPPLY = 1) AS ID,\n    \n    -- 关联标识字段\n    NULL AS CONTRACT_NUMBER,\n    NULL AS MATRL_NO,\n    m.FMATCODE,\n    \n    -- 合同甲供材信息\n    NULL AS CNM_DESC,\n    NULL AS UNIT_INV,\n    NULL AS ISSUE_QTY,\n    NULL AS ISSUE_PRICE,\n    NULL AS ISSUE_AMT,\n    \n    -- 预结算材料信息\n    m.FMATNAME,\n    m.FMATUNIT,\n    m.FSUMAMOUNT,\n    m.FPRICE,\n    \n    -- 材料分类信息\n    m.FJASUPPLYFROM,\n    m.FJASUPPLYCLASS0,\n    m.FJASUPPLYCLASS1,\n    m.FJASUPPLYCLASS2,\n    m.FJASUPPLYCLASS3,\n    \n    -- 领用人信息\n    m.CREATE_USER_NAME,\n    m.CREATE_TIME,\n    m.FMATMEMO,\n    \n    -- 对比分析字段\n    m.FSUMAMOUNT AS USAGE_DIFF,  -- 全部为超领\n    NULL AS USAGE_RATIO,         -- 无合同数量，无法计算比例\n    1 AS IS_OVER_USAGE,          -- 合同中未约定但实际领用，视为超领\n    \n    -- 系统字段\n    CURRENT_DATE AS ETL_DATE\n    \nFROM \n    TYSPF_MATERIAL m\nLEFT JOIN \n    CONTRACT_MATERIAL c ON m.FMATCODE = c.MATRL_NO\nWHERE \n    m.FJASUPPLY = 1  -- 只包含甲供材料\n    AND c.MATRL_NO IS NULL  -- 合同中没有的材料\n\nINSERT OVERWRITE TABLE\n\tdwi_eqp.dwi_eqp_lz_material_supply_analysis PARTITION (mt = '202506')",
	"currentDatabase":"dwi_eqp",
	"description":"",
	"directory":"/廉政专项/工程管理/宽表",
	"name":"etl_dwi_eqp_lz_material_supply_analysis",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}