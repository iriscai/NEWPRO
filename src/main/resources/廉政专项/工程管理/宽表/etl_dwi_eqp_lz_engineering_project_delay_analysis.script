{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025-07-15\n-- descr: 廉政八项-工程项目-工程工期延误分析\n-- ******************************************************************** --\n-- DROP TABLE IF EXISTS dwi_eqp.dwi_eqp_lz_engineering_project_delay_analysis;\n-- CREATE TABLE\n--     dwi_eqp.dwi_eqp_lz_engineering_project_delay_analysis (\n--     -- 合同基本信息\n--     CONTRACT_NUMBER VARCHAR(200) COMMENT '合同编号',\n--     PROJECT_CODE VARCHAR(200) COMMENT '项目编码',\n--     CONTRACT_NAME VARCHAR(200) COMMENT '合同名称',\n--     CONTRACT_TYPE VARCHAR(200) COMMENT '合同类型',\n--     DATA_TYPE VARCHAR(200) COMMENT '数据类型',\n--     CONTRACT_STATUS VARCHAR(200) COMMENT '合同状态',\n    \n--     -- 组织信息\n--     BRANCHFACTORY_CODE VARCHAR(200) COMMENT '分厂编码',\n--     BRANCHFACTORY_NAME VARCHAR(200) COMMENT '分厂名称',\n--     GENERALFACTORY_NAME VARCHAR(200) COMMENT '事业部名称',\n--     COMPANY_CODE VARCHAR(200) COMMENT '公司编码',\n--     COMPANY_NAME VARCHAR(200) COMMENT '公司名称',\n    \n--     -- 合同时间信息\n--     SIGN_DATE VARCHAR(200) COMMENT '签约日期',\n--     PLAN_START_DATE VARCHAR(200) COMMENT '计划开工日期',\n--     PLAN_END_DATE VARCHAR(200) COMMENT '计划完工日期',\n--     ACTUAL_START_DATE VARCHAR(200) COMMENT '实际开工日期',\n--     ACTUAL_END_DATE VARCHAR(200) COMMENT '实际完工日期',\n--     COMPLETION_TIME VARCHAR(200) COMMENT '完工时间',\n    \n--     -- 时间计算\n--     DELAY_DAYS DECIMAL(32,6) COMMENT '延期天数',\n--     PLANNED_DURATION_DAYS DECIMAL(32,6) COMMENT '计划工期（天）',\n--     ACTUAL_DURATION_DAYS DECIMAL(32,6) COMMENT '实际工期（天）',\n--     DURATION_EXTENSION_PERCENT DECIMAL(32,6) COMMENT '工期延长比例（%）',\n--     START_DELAY_DAYS DECIMAL(32,6) COMMENT '开工延迟天数',\n    \n--     -- 合同金额信息\n--     ORIGINAL_ORDER_AMOUNT DECIMAL(32,6) COMMENT '原始订单金额',\n--     UPDATED_ORDER_AMOUNT DECIMAL(32,6) COMMENT '更新订单金额',\n--     ORIGINAL_MATERIAL_AMOUNT DECIMAL(32,6) COMMENT '原始材料金额',\n--     UPDATED_MATERIAL_AMOUNT DECIMAL(32,6) COMMENT '更新材料金额',\n--     CONTRACT_PRICE DECIMAL(32,6) COMMENT '合同价格',\n--     FINAL_PRICE DECIMAL(32,6) COMMENT '最终价格',\n    \n--     -- 金额计算\n--     ORDER_AMOUNT_CHANGE DECIMAL(32,6) COMMENT '订单金额变更',\n--     CONTRACT_AMOUNT_CHANGE DECIMAL(32,6) COMMENT '合同金额变更',\n--     ORDER_AMOUNT_CHANGE_PERCENT DECIMAL(32,6) COMMENT '订单金额变更比例（%）',\n--     CONTRACT_AMOUNT_CHANGE_PERCENT DECIMAL(32,6) COMMENT '合同金额变更比例（%）',\n--     MATERIAL_AMOUNT_CHANGE DECIMAL(32,6) COMMENT '材料金额变更',\n--     MATERIAL_AMOUNT_CHANGE_PERCENT DECIMAL(32,6) COMMENT '材料金额变更比例（%）',\n    \n--     -- 其他合同参数\n--     IMPREST_PERCENT DECIMAL(32,6) COMMENT '预付款比例',\n--     IMPREST_PERCENT_EQ DECIMAL(32,6) COMMENT '设备预付款比例',\n--     IMPREST_PERCENT_OTHER DECIMAL(32,6) COMMENT '其他预付款比例',\n--     GUARANTEE_PERCENT DECIMAL(32,6) COMMENT '保证金比例',\n--     GUARANTEE_PERCENT_EQ DECIMAL(32,6) COMMENT '设备保证金比例',\n--     GUARANTEE_PERCENT_OTHER DECIMAL(32,6) COMMENT '其他保证金比例',\n--     IS_PROVIDE_MATERIAL VARCHAR(200) COMMENT '是否提供材料',\n    \n--     -- 签证记录信息\n--     VISA_COUNT DECIMAL(32,6) COMMENT '签证数量',\n--     EARLIEST_VISA_START_TIME VARCHAR(200) COMMENT '最早签证开始时间',\n--     LATEST_VISA_END_TIME VARCHAR(200) COMMENT '最晚签证结束时间',\n--     FIRST_VISA_DATE VARCHAR(200) COMMENT '首次签证日期',\n--     LAST_VISA_DATE VARCHAR(200) COMMENT '最近签证日期',\n    \n--     -- 签证时间计算\n--     VISA_DURATION_DAYS DECIMAL(32,6) COMMENT '签证持续时间（天）',\n--     VISA_AFFECTS_DURATION_FLAG DECIMAL(32,6) COMMENT '签证是否影响工期（1=是，0=否）',\n--     VISA_DURATION_PERCENT DECIMAL(32,6) COMMENT '签证持续时间占计划工期比例（%）',\n    \n--     -- 质量问题信息\n--     ISSUES_COUNT DECIMAL(32,6) COMMENT '问题数量',\n--     TOTAL_DEDUCTION DECIMAL(32,6) COMMENT '扣款总金额',\n--     EARLIEST_ISSUE_DATE VARCHAR(200) COMMENT '最早问题日期',\n--     LATEST_CLOSE_DATE VARCHAR(200) COMMENT '最晚关闭日期',\n    \n--     -- 质量问题计算\n--     DEDUCTION_PERCENT DECIMAL(32,6) COMMENT '扣款占合同金额百分比（%）',\n--     QUALITY_ISSUES_DURATION_DAYS DECIMAL(32,6) COMMENT '质量问题持续时间（天）',\n--     QUALITY_AFFECTS_DURATION_FLAG DECIMAL(32,6) COMMENT '质量问题是否影响工期（1=是，0=否）',\n--     AVG_DEDUCTION_PER_ISSUE DECIMAL(32,6) COMMENT '平均每个质量问题的扣款金额',\n        \n--     -- 延期分类\n--     DELAY_CATEGORY VARCHAR(200) COMMENT '延期分类',\n    \n--     -- 系统字段\n--     ETL_DATE VARCHAR(200) COMMENT 'ETL处理日期',\n--     UPDATE_TIME VARCHAR(200) COMMENT '更新时间'\n--     )\n-- COMMENT '廉政八项-工程项目-工程工期延误分析'\n-- PARTITIONED BY (mt STRING COMMENT '分区月份')\n-- STORED AS ORC;\n\n\n-- 签证记录\nDROP VIEW IF EXISTS dwi_eqp.dwi_eqp_lz_delay_analysis_jd_cbm_visa;\nCREATE VIEW dwi_eqp.dwi_eqp_lz_delay_analysis_jd_cbm_visa AS \nSELECT \n    CONTRACT_NUMBER,                                       -- 项目合同编号\n    CONTRACT_NAME,                                         -- 合同名称\n    GENERALFACTORY_CODE,                                   -- 事业部编码\n    GENERALFACTORY_NAME,                                   -- 事业部名称\n    COMPANY_CODE,                                          -- 施工单位编号\n    COMPANY_NAME,                                          -- 施工单位名称\n    COUNT(*) AS VISA_COUNT,                                -- 签证总数量\n        -- 处理最早签证施工开始时间，如果全为空则取签证时间\n    CASE \n        WHEN MIN(CASE WHEN ACTUAL_START_DATETIME IS NOT NULL AND TRIM(ACTUAL_START_DATETIME) != '' \n                 THEN ACTUAL_START_DATETIME END) IS NULL \n        THEN MIN(CASE WHEN BILL_DATETIME IS NOT NULL AND TRIM(BILL_DATETIME) != '' \n                 THEN BILL_DATETIME END)\n        ELSE MIN(CASE WHEN ACTUAL_START_DATETIME IS NOT NULL AND TRIM(ACTUAL_START_DATETIME) != '' \n                 THEN ACTUAL_START_DATETIME END)\n    END AS EARLIEST_VISA_START_TIME,\n    \n    -- 处理最晚签证施工结束时间，如果全为空则取签证时间\n    CASE \n        WHEN MAX(CASE WHEN ACTUAL_END_DATETIME IS NOT NULL AND TRIM(ACTUAL_END_DATETIME) != '' \n                 THEN ACTUAL_END_DATETIME END) IS NULL \n        THEN MAX(CASE WHEN BILL_DATETIME IS NOT NULL AND TRIM(BILL_DATETIME) != '' \n                 THEN BILL_DATETIME END)\n        ELSE MAX(CASE WHEN ACTUAL_END_DATETIME IS NOT NULL AND TRIM(ACTUAL_END_DATETIME) != '' \n                 THEN ACTUAL_END_DATETIME END)\n    END AS LATEST_VISA_END_TIME,\n    \n    -- 首次签证时间\n    MIN(CASE WHEN BILL_DATETIME IS NOT NULL AND TRIM(BILL_DATETIME) != '' \n         THEN BILL_DATETIME END) AS FIRST_VISA_DATE,\n    \n    -- 最近签证时间\n    MAX(CASE WHEN BILL_DATETIME IS NOT NULL AND TRIM(BILL_DATETIME) != '' \n         THEN BILL_DATETIME END) AS LAST_VISA_DATE\nFROM \n    dwi_eqp.dwi_eqp_jd_cbm_visa_lz\nGROUP BY\n    CONTRACT_NUMBER,\n    CONTRACT_NAME,\n    GENERALFACTORY_CODE,\n    GENERALFACTORY_NAME,\n    COMPANY_CODE,\n    COMPANY_NAME;\n    \n    \n    \n-- 质量问题\nDROP VIEW IF EXISTS dwi_eqp.dwi_eqp_lz_delay_analysis_tbkpmq1;\nCREATE VIEW dwi_eqp.dwi_eqp_lz_delay_analysis_tbkpmq1 AS \nSELECT \n    CIMP1NO,                                               -- 项目立项号\n    KPMC1NO,                                               -- 合同号\n    CONTRACTNAME,                                          -- 合同名称\n    KPMM1NO,                                               -- 承包厂商编号\n    RESPONDEPT,                                            -- 问题责任单位\n    \n    -- 问题总数\n    COUNT(*) AS ISSUES_COUNT,\n    \n    -- 扣款总金额\n    SUM(COALESCE(DEDUCTION, 0)) AS TOTAL_DEDUCTION,\n    \n    -- 最早问题计划整改日期\n    MIN(CASE WHEN RECTIFYPLANDATE IS NOT NULL AND TRIM(RECTIFYPLANDATE) != '' \n         THEN RECTIFYPLANDATE END) AS EARLIEST_ISSUE_DATE,\n    \n    -- 最晚问题关闭日期（如果关闭日期为空，则尝试使用期望关闭日期）\n    CASE \n        WHEN MAX(CASE WHEN ACTCLOSEDATE IS NOT NULL AND TRIM(ACTCLOSEDATE) != '' \n                 THEN ACTCLOSEDATE END) IS NULL \n        THEN MAX(CASE WHEN HOPECLOSEDATE IS NOT NULL AND TRIM(HOPECLOSEDATE) != '' \n                 THEN HOPECLOSEDATE END)\n        ELSE MAX(CASE WHEN ACTCLOSEDATE IS NOT NULL AND TRIM(ACTCLOSEDATE) != '' \n                 THEN ACTCLOSEDATE END)\n    END AS LATEST_CLOSE_DATE\nFROM \n    dwi_eqp.dwi_eqp_tbkpmq1_lz\nGROUP BY\n    CIMP1NO,\n    KPMC1NO,\n    CONTRACTNAME,\n    KPMM1NO,\n    RESPONDEPT;\n    \n    \n\nDROP VIEW IF EXISTS dwi_eqp.dwi_eqp_lz_delay_analysis_jd_cbm_contract;\nCREATE VIEW dwi_eqp.dwi_eqp_lz_delay_analysis_jd_cbm_contract AS \nSELECT \n    -- 合同基本信息 (优先使用JD_CBM_CONTRACT表的数据)\n    COALESCE(j.CONTRACT_NUMBER, c.kpmc1no) AS CONTRACT_NUMBER,\n    COALESCE(j.PROJECT_CODE, c.kpmc1noa) AS PROJECT_CODE,\n    COALESCE(j.CONTRACT_NAME, c.contractname) AS CONTRACT_NAME,\n    COALESCE(j.CONTRACT_TYPE, c.kpmc1noc) AS CONTRACT_TYPE,\n    j.DATA_TYPE,\n    c.cancelstatus AS CONTRACT_STATUS,\n    \n    -- 组织信息\n    j.BRANCHFACTORY_CODE,\n    j.BRANCHFACTORY_NAME,\n    j.GENERALFACTORY_NAME,\n    j.COMPANY_CODE,\n    j.COMPANY_NAME,\n    \n    -- -- 时间参数 (合并两个表的时间信息)\n    c.signdate AS SIGN_DATE, --合同表签约日期\n    IFNULL(j.PLAN_START_DATETIME,c.eststartdate) AS PLAN_START_DATE,\n    IFNULL(j.PLAN_END_DATETIME,c.estfinishdate) AS PLAN_END_DATE,\n    j.ACTUAL_START_DATE,\n    j.ACTUAL_END_DATE,\n    j.COMPLETION_TIME,\n    \n    -- 金额参数\n    c.originalorderamt AS ORIGINAL_ORDER_AMOUNT,\n    c.updorderamt AS UPDATED_ORDER_AMOUNT,\n    c.originalmaterialamt AS ORIGINAL_MATERIAL_AMOUNT,\n    c.updmaterialamt AS UPDATED_MATERIAL_AMOUNT,\n    j.CONTRACT_PRICE,\n    j.FINAL_PRICE,\n    \n    -- 其他参数\n    c.imprestPercent AS IMPREST_PERCENT,\n    c.imprestPercentEq AS IMPREST_PERCENT_EQ,\n    c.imprestPercentOther AS IMPREST_PERCENT_OTHER,\n    c.guaranteePercent AS GUARANTEE_PERCENT,\n    c.guaranteePercentEq AS GUARANTEE_PERCENT_EQ,\n    c.guaranteePercentOther AS GUARANTEE_PERCENT_OTHER,\n    c.isProvideMaterial AS IS_PROVIDE_MATERIAL\nFROM \n    dwi_eqp.dwi_eqp_tbkpmc1_lz c\nFULL OUTER JOIN \n    dwi_eqp.dwi_eqp_jd_cbm_contract_lz\t j ON c.kpmc1no = j.CONTRACT_NUMBER;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n-- 创建合同延期分析宽表\nINSERT OVERWRITE TABLE\n\tdwi_eqp.dwi_eqp_lz_engineering_project_delay_analysis PARTITION (mt = '202507')\nSELECT \n    -- 合同基本信息\n    c.CONTRACT_NUMBER,\n    c.PROJECT_CODE,\n    c.CONTRACT_NAME,\n    c.CONTRACT_TYPE,\n    c.DATA_TYPE,\n    c.CONTRACT_STATUS,\n    \n    -- 组织信息\n    c.BRANCHFACTORY_CODE,\n    c.BRANCHFACTORY_NAME,\n    c.GENERALFACTORY_NAME,\n    c.COMPANY_CODE,\n    c.COMPANY_NAME,\n    \n    -- 合同时间信息\n    c.SIGN_DATE,\n    c.PLAN_START_DATE,\n    c.PLAN_END_DATE,\n    c.ACTUAL_START_DATE,\n    c.ACTUAL_END_DATE,\n    c.COMPLETION_TIME,\n    \n    -- 时间计算\n    CASE \n        WHEN c.ACTUAL_END_DATE IS NOT NULL AND c.PLAN_END_DATE IS NOT NULL \n        THEN DATEDIFF(c.ACTUAL_END_DATE, c.PLAN_END_DATE)\n        ELSE NULL\n    END AS DELAY_DAYS,\n    \n    -- 计划工期（天）\n    CASE \n        WHEN c.PLAN_START_DATE IS NOT NULL AND c.PLAN_END_DATE IS NOT NULL \n        THEN DATEDIFF(c.PLAN_END_DATE, c.PLAN_START_DATE)\n        ELSE NULL\n    END AS PLANNED_DURATION_DAYS,\n    \n    -- 实际工期（天）\n    CASE \n        WHEN c.ACTUAL_START_DATE IS NOT NULL AND c.ACTUAL_END_DATE IS NOT NULL \n        THEN DATEDIFF(c.ACTUAL_END_DATE, c.ACTUAL_START_DATE)\n        ELSE NULL\n    END AS ACTUAL_DURATION_DAYS,\n    \n    -- 工期延长比例（%）\n    CASE \n        WHEN c.ACTUAL_START_DATE IS NOT NULL AND c.ACTUAL_END_DATE IS NOT NULL \n             AND c.PLAN_START_DATE IS NOT NULL AND c.PLAN_END_DATE IS NOT NULL\n             AND DATEDIFF(c.PLAN_END_DATE, c.PLAN_START_DATE) > 0\n        THEN (DATEDIFF(c.ACTUAL_END_DATE, c.ACTUAL_START_DATE) - DATEDIFF(c.PLAN_END_DATE, c.PLAN_START_DATE)) \n             / DATEDIFF(c.PLAN_END_DATE, c.PLAN_START_DATE) * 100\n        ELSE NULL\n    END AS DURATION_EXTENSION_PERCENT,\n    \n    -- 开工延迟天数\n    CASE \n        WHEN c.ACTUAL_START_DATE IS NOT NULL AND c.PLAN_START_DATE IS NOT NULL \n        THEN DATEDIFF(c.ACTUAL_START_DATE, c.PLAN_START_DATE)\n        ELSE NULL\n    END AS START_DELAY_DAYS,\n    \n    -- 合同金额信息\n    c.ORIGINAL_ORDER_AMOUNT,\n    c.UPDATED_ORDER_AMOUNT,\n    c.ORIGINAL_MATERIAL_AMOUNT,\n    c.UPDATED_MATERIAL_AMOUNT,\n    c.CONTRACT_PRICE,\n    c.FINAL_PRICE,\n    \n    -- 金额计算\n    COALESCE(c.UPDATED_ORDER_AMOUNT, 0) - COALESCE(c.ORIGINAL_ORDER_AMOUNT, 0) AS ORDER_AMOUNT_CHANGE,\n    COALESCE(c.FINAL_PRICE, 0) - COALESCE(c.CONTRACT_PRICE, 0) AS CONTRACT_AMOUNT_CHANGE,\n    \n    -- 金额变更比例（%）\n    CASE \n        WHEN c.ORIGINAL_ORDER_AMOUNT IS NOT NULL AND c.ORIGINAL_ORDER_AMOUNT != 0 \n        THEN (COALESCE(c.UPDATED_ORDER_AMOUNT, 0) - c.ORIGINAL_ORDER_AMOUNT) / c.ORIGINAL_ORDER_AMOUNT * 100\n        ELSE NULL\n    END AS ORDER_AMOUNT_CHANGE_PERCENT,\n    \n    CASE \n        WHEN c.CONTRACT_PRICE IS NOT NULL AND c.CONTRACT_PRICE != 0 \n        THEN (COALESCE(c.FINAL_PRICE, 0) - c.CONTRACT_PRICE) / c.CONTRACT_PRICE * 100\n        ELSE NULL\n    END AS CONTRACT_AMOUNT_CHANGE_PERCENT,\n    \n    -- 材料金额变更\n    COALESCE(c.UPDATED_MATERIAL_AMOUNT, 0) - COALESCE(c.ORIGINAL_MATERIAL_AMOUNT, 0) AS MATERIAL_AMOUNT_CHANGE,\n    \n    -- 材料金额变更比例（%）\n    CASE \n        WHEN c.ORIGINAL_MATERIAL_AMOUNT IS NOT NULL AND c.ORIGINAL_MATERIAL_AMOUNT != 0 \n        THEN (COALESCE(c.UPDATED_MATERIAL_AMOUNT, 0) - c.ORIGINAL_MATERIAL_AMOUNT) / c.ORIGINAL_MATERIAL_AMOUNT * 100\n        ELSE NULL\n    END AS MATERIAL_AMOUNT_CHANGE_PERCENT,\n    \n    -- 其他合同参数\n    c.IMPREST_PERCENT,\n    c.IMPREST_PERCENT_EQ,\n    c.IMPREST_PERCENT_OTHER,\n    c.GUARANTEE_PERCENT,\n    c.GUARANTEE_PERCENT_EQ,\n    c.GUARANTEE_PERCENT_OTHER,\n    c.IS_PROVIDE_MATERIAL,\n    \n    -- 签证记录信息\n    v.VISA_COUNT,\n    v.EARLIEST_VISA_START_TIME,\n    v.LATEST_VISA_END_TIME,\n    v.FIRST_VISA_DATE,\n    v.LAST_VISA_DATE,\n    \n    -- 签证时间计算\n    CASE \n        WHEN v.LATEST_VISA_END_TIME IS NOT NULL AND v.EARLIEST_VISA_START_TIME IS NOT NULL \n        THEN DATEDIFF(v.LATEST_VISA_END_TIME, v.EARLIEST_VISA_START_TIME)\n        ELSE NULL\n    END AS VISA_DURATION_DAYS,\n    \n    -- 签证是否影响工期\n    CASE \n        WHEN v.LATEST_VISA_END_TIME IS NOT NULL AND c.PLAN_END_DATE IS NOT NULL \n             AND v.LATEST_VISA_END_TIME > c.PLAN_END_DATE\n        THEN 1\n        ELSE 0\n    END AS VISA_AFFECTS_DURATION_FLAG,\n    \n    -- 签证持续时间占计划工期比例（%）\n    CASE \n        WHEN v.LATEST_VISA_END_TIME IS NOT NULL AND v.EARLIEST_VISA_START_TIME IS NOT NULL \n             AND c.PLAN_START_DATE IS NOT NULL AND c.PLAN_END_DATE IS NOT NULL\n             AND DATEDIFF(c.PLAN_END_DATE, c.PLAN_START_DATE) > 0\n        THEN DATEDIFF(v.LATEST_VISA_END_TIME, v.EARLIEST_VISA_START_TIME) \n             / DATEDIFF(c.PLAN_END_DATE, c.PLAN_START_DATE) * 100\n        ELSE NULL\n    END AS VISA_DURATION_PERCENT,\n    \n    -- 质量问题信息\n    q.ISSUES_COUNT,\n    q.TOTAL_DEDUCTION,\n    q.EARLIEST_ISSUE_DATE,\n    q.LATEST_CLOSE_DATE,\n    \n    -- 质量问题计算\n    CASE \n        WHEN q.TOTAL_DEDUCTION IS NOT NULL AND c.CONTRACT_PRICE IS NOT NULL AND c.CONTRACT_PRICE != 0\n        THEN q.TOTAL_DEDUCTION / c.CONTRACT_PRICE * 100\n        ELSE NULL\n    END AS DEDUCTION_PERCENT,\n    \n    -- 质量问题持续时间（天）\n    CASE \n        WHEN q.LATEST_CLOSE_DATE IS NOT NULL AND q.EARLIEST_ISSUE_DATE IS NOT NULL \n        THEN DATEDIFF(q.LATEST_CLOSE_DATE, q.EARLIEST_ISSUE_DATE)\n        ELSE NULL\n    END AS QUALITY_ISSUES_DURATION_DAYS,\n    \n    -- 质量问题是否影响工期\n    CASE \n        WHEN q.LATEST_CLOSE_DATE IS NOT NULL AND c.PLAN_END_DATE IS NOT NULL \n             AND q.LATEST_CLOSE_DATE > c.PLAN_END_DATE\n        THEN 1\n        ELSE 0\n    END AS QUALITY_AFFECTS_DURATION_FLAG,\n    \n    -- 平均每个质量问题的扣款金额\n    CASE \n        WHEN q.ISSUES_COUNT IS NOT NULL AND q.ISSUES_COUNT > 0 AND q.TOTAL_DEDUCTION IS NOT NULL\n        THEN q.TOTAL_DEDUCTION / q.ISSUES_COUNT\n        ELSE NULL\n    END AS AVG_DEDUCTION_PER_ISSUE,\n    \n    -- 延期分类\n    CASE \n        WHEN c.ACTUAL_END_DATE IS NULL OR c.PLAN_END_DATE IS NULL THEN '未知'\n        WHEN DATEDIFF(c.ACTUAL_END_DATE, c.PLAN_END_DATE) <= 0 THEN '按期或提前'\n        WHEN DATEDIFF(c.ACTUAL_END_DATE, c.PLAN_END_DATE) BETWEEN 1 AND 7 THEN '轻微延期(<7天)'\n        WHEN DATEDIFF(c.ACTUAL_END_DATE, c.PLAN_END_DATE) BETWEEN 8 AND 30 THEN '中度延期(8-30天)'\n        ELSE '严重延期(>30天)'\n    END AS DELAY_CATEGORY,\n    current_date(),current_date()\n    \nFROM \n    dwi_eqp.dwi_eqp_lz_delay_analysis_jd_cbm_contract c\nLEFT JOIN \n    dwi_eqp.dwi_eqp_lz_delay_analysis_jd_cbm_visa v \n    ON c.CONTRACT_NUMBER = v.CONTRACT_NUMBER\nLEFT JOIN \n    dwi_eqp.dwi_eqp_lz_delay_analysis_tbkpmq1 q \n    ON c.CONTRACT_NUMBER = q.KPMC1NO;\n",
	"currentDatabase":"dwi_eqp",
	"description":"",
	"directory":"/廉政专项/工程管理/宽表",
	"name":"etl_dwi_eqp_lz_engineering_project_delay_analysis",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}