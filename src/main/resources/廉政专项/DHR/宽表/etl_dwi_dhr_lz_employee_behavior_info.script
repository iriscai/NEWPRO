{
	"configuration":{},
	"connectionName":"MRS_Spark_Agent",
	"content":"-- SPARK sql \n-- ******************************************************************** --\n-- author: jh_caiyi\n-- create time: 2025/05/26 13:04:52 GMT+08:00\n-- descr: 廉政八项-DHR专线-人员行为信息表\n-- ******************************************************************** --\n-- CREATE TABLE\n--         dwi_hrm.dwi_dhr_lz_employee_behavior_info\n--         (\n--                 id STRING COMMENT '主键ID',\n--                 main_industry STRING COMMENT '主业/新产业',\n--                 company_id STRING COMMENT '公司ID',\n--                 employee_id STRING COMMENT '人员ID',\n--                 depart_id STRING COMMENT '部门ID',\n--                 position_id STRING COMMENT '岗位ID',\n--                 date STRING COMMENT '日期',\n--                 shift_id STRING COMMENT '班次ID',\n--                 punchin_early STRING COMMENT '最早打卡时间',\n--                 punchin_late STRING COMMENT '最晚打卡时间',\n--                 punchin_early_description STRING COMMENT '最早打卡时间描述',\n--                 punchin_late_description STRING COMMENT '最晚打卡时间描述',\n--                 work_onjob STRING COMMENT '在岗时间',\n--                 work_actual STRING COMMENT '实际出勤时间',\n--                 work_rest STRING COMMENT '休息时间',\n--                 work_outjob STRING COMMENT '外出时间',\n--                 work_absence STRING COMMENT '缺勤时间',\n--                 work_late STRING COMMENT '迟到时间',\n--                 work_early STRING COMMENT '早退时间',\n--                 overtime_normal STRING COMMENT '平常日加班时间',\n--                 overtime_rest STRING COMMENT '休息日加班时间',\n--                 overtime_holiday STRING COMMENT '节假日加班时间',\n--                 attend_item_id STRING COMMENT '休假项目',\n--                 leave_item STRING COMMENT '休假项目日报项目',\n--                 start_time STRING COMMENT '开始时间',\n--                 end_time STRING COMMENT '结束时间',\n--                 start_time_plan STRING COMMENT '计划开始时间',\n--                 end_time_plan STRING COMMENT '计划结束时间',\n--                 accounting_len STRING COMMENT '预计时长',\n--                 calc_unit STRING COMMENT '预计时长单位;1-小时,2-天',\n--                 source STRING COMMENT '来源;0-流程单据,1-文件导入,2-台账登记',\n--                 department_id STRING COMMENT '所属部门',\n--                 state STRING COMMENT '单据状态;1-新增,2-生效,3-未生效,4-生效失败,5-废弃,6-审批失效',\n--                 approve_state STRING COMMENT '审批状态;0-暂存,1-审批中,2-审批通过,3-审批拒绝,4-撤销',\n--                 adapter_id STRING COMMENT '线下数据ID',\n--                 wf_inst_id STRING COMMENT '流程实例ID',\n--                 report_approve_state STRING COMMENT '销假审批状态;0-暂存,1-审批中,2-审批通过,3-审批拒绝,4-撤销',\n--                 report_wf_inst_id STRING COMMENT '销假流程实例ID',\n--                 reason STRING COMMENT '申请原因',\n--                 remark STRING COMMENT '备注',\n--                 attachment_index STRING COMMENT '附件',\n--                 create_time STRING COMMENT '创建时间',\n--                 creator_id STRING COMMENT '创建人员',\n--                 operate_time STRING COMMENT '发生时间',\n--                 operator_id STRING COMMENT '操作人',\n--                 actual_len STRING COMMENT '实际时长',\n--                 business_org_id STRING COMMENT '方案所属考勤组织',\n--                 turn_to_take_off STRING COMMENT '转调休',\n--                 updater_id STRING COMMENT '更新人员',\n--                 modified_time STRING COMMENT '修改时间',\n--                 approve_finish_date STRING COMMENT '审批结束时间',\n--                 historical_duration STRING COMMENT '历史请假时长',\n--                 start_time2 STRING COMMENT '开始时间2',\n--                 end_time2 STRING COMMENT '结束时间2',\n--                 employee STRING COMMENT '人员',\n--                 business_trip_item STRING COMMENT '出差项目',\n--                 business_trip_item_report STRING COMMENT '日报项目',\n--                 business_trip_start_time STRING COMMENT '开始时间',\n--                 business_trip_end_time STRING COMMENT '结束时间',\n--                 business_trip_start_time_plan STRING COMMENT '计划开始时间',\n--                 business_trip_end_time_plan STRING COMMENT '计划结束时间',\n--                 business_trip_source STRING COMMENT '来源',\n--                 business_trip_adapter_id STRING COMMENT '线下数据ID',\n--                 business_trip_department_id STRING COMMENT '组织',\n--                 business_trip_state STRING COMMENT '状态',\n--                 business_trip_approve_state STRING COMMENT '审批状态;0-暂存,1-审批中,2-审批通过,3-审批拒绝,4-撤销',\n--                 business_trip_wf_inst_id STRING COMMENT '流程实例ID',\n--                 business_trip_report_approve_state STRING COMMENT '销差审批状态',\n--                 business_trip_report_wf_inst_id STRING COMMENT '销差流程实例ID',\n--                 address STRING COMMENT '出差地点',\n--                 method STRING COMMENT '出差方式',\n--                 business_trip_reason STRING COMMENT '申请原因',\n--                 business_trip_remark STRING COMMENT '备注',\n--                 business_trip_attachment_index STRING COMMENT '附件',\n--                 business_trip_create_time STRING COMMENT '创建时间',\n--                 business_trip_creator_id STRING COMMENT '创建人员',\n--                 business_trip_operate_time STRING COMMENT '发生时间',\n--                 business_trip_operator_id STRING COMMENT '操作人',\n--                 business_trip_approve_finish_date STRING COMMENT '审批结束时间',\n--                 business_trip_updater_id STRING COMMENT '更新人员',\n--                 business_trip_modified_time STRING COMMENT '修改时间',\n--                 description STRING COMMENT '描述'\n--         ) COMMENT '人员行为信息表' STORED AS orc TBLPROPERTIES (\"orc.compress\" = \"SNAPPY\");\nTRUNCATE TABLE dwi_hrm.dwi_dhr_lz_employee_behavior_info;\nINSERT\n        OVERWRITE TABLE dwi_hrm.dwi_dhr_lz_employee_behavior_info\nSELECT\n        time_attend_data.id                              , -- 主键ID\n        \"主业\" AS main_industry, -- 主业/新产业\n        time_attend_data.company_id                      , -- 公司ID\n        time_attend_data.employee_id                     , -- 人员ID\n        time_leave_data.department_id AS depart_id                       , -- 部门ID\n        time_attend_data.position_id                     , -- 岗位ID\n        time_attend_data.date                            , -- 日期\n        time_attend_data.shift_id                        , -- 班次ID\n        time_attend_data.punchin_early                   , -- 最早打卡时间\n        time_attend_data.punchin_late                    , -- 最晚打卡时间\n        time_attend_data.punchin_early_description       , -- 最早打卡时间描述\n        time_attend_data.punchin_late_description        , -- 最晚打卡时间描述\n        time_attend_data.work_onjob                      , -- 在岗时间\n        time_attend_data.work_actual                     , -- 实际出勤时间\n        time_attend_data.work_rest                       , -- 休息时间\n        time_attend_data.work_outjob                     , -- 外出时间\n        time_attend_data.work_absence                    , -- 缺勤时间\n        time_attend_data.work_late                       , -- 迟到时间\n        time_attend_data.work_early                      , -- 早退时间\n        time_attend_data.overtime_normal                 , -- 平常日加班时间\n        time_attend_data.overtime_rest                   , -- 休息日加班时间\n        time_attend_data.overtime_holiday                , -- 节假日加班时间\n        time_leave_data.id AS attend_item_id                  , -- 休假项目\n        time_leave_data.leave_item                      , -- 休假项目日报项目\n        time_leave_data.start_time                      , -- 开始时间\n        time_leave_data.end_time                        , -- 结束时间\n        time_leave_data.start_time_plan                 , -- 计划开始时间\n        time_leave_data.end_time_plan                   , -- 计划结束时间\n        time_leave_data.accounting_len                  , -- 预计时长\n        time_leave_data.calc_unit                       , -- 预计时长单位\n        time_leave_data.source                          , -- 来源\n        time_leave_data.department_id                   , -- 所属部门\n        time_leave_data.state                           , -- 单据状态\n        time_leave_data.approve_state                   , -- 审批状态\n        time_leave_data.adapter_id                      , -- 线下数据ID\n        time_leave_data.wf_inst_id                      , -- 流程实例ID\n        time_leave_data.report_approve_state            , -- 销假审批状态\n        time_leave_data.report_wf_inst_id               , -- 销假流程实例ID\n        time_leave_data.reason                          , -- 申请原因\n        time_leave_data.remark                          , -- 备注\n        time_leave_data.attachment_index                , -- 附件\n        time_leave_data.create_time                     , -- 创建时间\n        time_leave_data.creator_id                      , -- 创建人员\n        time_leave_data.operate_time                    , -- 发生时间\n        time_leave_data.operator_id                     , -- 操作人\n        time_leave_data.actual_len                      , -- 实际时长\n        time_leave_data.business_org_id                 , -- 方案所属考勤组织\n        time_leave_data.turn_to_take_off                , -- 转调休\n        time_leave_data.updater_id                      , -- 更新人员\n        time_leave_data.modified_time                   , -- 修改时间\n        time_leave_data.approve_finish_date             , -- 审批结束时间\n        \"\" AS historical_duration             , -- 历史请假时长\n        time_leave_data.start_time AS start_time2                     , -- 开始时间2\n        time_leave_data.end_time AS end_time2                       , -- 结束时间2\n        time_leave_data.employee_id                        , -- 人员\n        business_trip_data.attend_item_id AS item              , -- 出差项目\n        business_trip_data.business_trip_item AS item_report       , -- 日报项目\n        business_trip_data.start_time        , -- 开始时间\n        business_trip_data.end_time          , -- 结束时间\n        business_trip_data.start_time_plan   , -- 计划开始时间\n        business_trip_data.end_time_plan     , -- 计划结束时间\n        business_trip_data.source            , -- 来源\n        business_trip_data.adapter_id        , -- 线下数据ID\n        business_trip_data.department_id     , -- 组织\n        business_trip_data.state             , -- 状态\n        business_trip_data.approve_state     , -- 审批状态\n        business_trip_data.wf_inst_id        , -- 流程实例ID\n        business_trip_data.report_approve_state, -- 销差审批状态\n        business_trip_data.report_wf_inst_id , -- 销差流程实例ID\n        business_trip_data.address                         , -- 出差地点\n        business_trip_data.method                          , -- 出差方式\n        business_trip_data.reason            , -- 申请原因\n        business_trip_data.remark            , -- 备注\n        business_trip_data.attachment_index  , -- 附件\n        business_trip_data.create_time       , -- 创建时间\n        business_trip_data.creator_id        , -- 创建人员\n        business_trip_data.operate_time      , -- 发生时间\n        business_trip_data.operator_id       , -- 操作人\n        business_trip_data.approve_finish_date, -- 审批结束时间\n        business_trip_data.updater_id        , -- 更新人员\n        business_trip_data.modified_time     , -- 修改时间\n        \"\" AS description                       -- 描述\nFROM\ndwi_hrm.dwi_hrm_time_attend_data_lz time_attend_data \nLEFT JOIN  dwi_hrm.dwi_hrm_time_leave_data_lz  time_leave_data ON  time_attend_data.employee_id=time_leave_data.employee_id AND time_attend_data.date=substr(time_leave_data.start_time,1,10)\nLEFT JOIN  dwi_hrm.dwi_hrm_time_business_trip_data_lz business_trip_data ON  time_attend_data.employee_id=business_trip_data.employee_id AND time_attend_data.date=substr(business_trip_data.start_time,1,10)\nwhere time_attend_data.date>'2025-06-01'\n;\n\n-- \tSELECT * FROM dwi_hrm.dwi_hrm_time_attend_data_lz where employee_id='3074503' AND date='2025-06-02';\n-- \tSELECT * FROM dwi_hrm.dwi_hrm_time_leave_data_lz where employee_id='3074503' AND substr(start_time,1,10)='2025-06-02';\n-- \tSELECT * FROM dwi_hrm.dwi_hrm_time_business_trip_data_lz where employee_id='3074503' AND substr(start_time,1,10)='2025-06-02';\n\n\n\n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \nDROP VIEW IF EXISTS dwi_hrm.dwi_dhr_lz_employee_behavior_info_view_xcy_punch_record;\nCREATE VIEW dwi_hrm.dwi_dhr_lz_employee_behavior_info_view_xcy_punch_record AS \n        SELECT id,substr(punch_time,1,10) AS punch_date,employee_no,punch_point,company_id,MIN(punch_time) OVER (PARTITION BY substr(punch_time,1,10),employee_no,punch_point,company_id) AS punchin_late,\n        MAX(punch_time) OVER (PARTITION BY substr(punch_time,1,10),employee_no,punch_point,company_id) AS punchin_early FROM dwi_hrm.dwi_hrm_punch_record_lz ;        \nINSERT\n        OVERWRITE TABLE dwi_hrm.dwi_dhr_lz_employee_behavior_info\nSELECT\n        xcy_punch_record.id                              , -- 主键ID\n        \"新产业\" AS main_industry, -- 主业/新产业\n        xcy_punch_record.company_id                      , -- 公司ID\n        xcy_punch_record.employee_no AS employee_id                     , -- 人员ID\n        attend_personal_record.dept_id AS depart_id                       , -- 部门ID\n        hr_user_position.sequence_id AS position_id                     , -- 岗位ID-- hr_user_position.position_id AS position_id          \n        xcy_punch_record.punch_date AS date                            , -- 日期\n        attend_personal_record.order_work AS shift_id                        , -- 班次ID\n        xcy_punch_record.punchin_early                   , -- 最早打卡时间\n        xcy_punch_record.punchin_late                    , -- 最晚打卡时间\n        \"\" AS punchin_early_description       , -- 最早打卡时间描述\n        \"\" AS punchin_late_description        , -- 最晚打卡时间描述\n        \"\" AS work_onjob                      , -- 在岗时间\n        \"\" AS work_actual                     , -- 实际出勤时间\n        \"\" AS work_rest                       , -- 休息时间\n        \"\" AS work_outjob                     , -- 外出时间\n        \"\" AS work_absence                    , -- 缺勤时间\n        attend_record.come_late_hours AS work_late                       , -- 迟到时间\n        attend_record.leave_early_hours AS work_early                      , -- 早退时间\n        \"\" AS overtime_normal                 , -- 平常日加班时间\n        \"\" AS overtime_rest                   , -- 休息日加班时间\n        \"\" AS overtime_holiday                , -- 节假日加班时间\n        holiday_book.id AS attend_item_id                  , -- 休假项目\n        holiday_book.title AS leave_item                      , -- 休假项目日报项目\n        holiday_book.start_time                      , -- 开始时间\n        holiday_book.end_time                        , -- 结束时间\n        holiday_book.start_time AS start_time_plan                 , -- 计划开始时间\n        holiday_book.end_time   AS end_time_plan                   , -- 计划结束时间\n        datediff(holiday_book.start_time,holiday_book.end_time) AS accounting_len                  , -- 预计时长\n        \"DAY\" AS calc_unit                       , -- 预计时长单位\n        \"\" AS source                          , -- 来源\n        attend_personal_record.dept_id AS department_id                   , -- 所属部门\n        \"\" AS state                           , -- 单据状态\n        \"\" AS approve_state                   , -- 审批状态\n        \"\" AS adapter_id                      , -- 线下数据ID\n        \"\" AS wf_inst_id                      , -- 流程实例ID\n        \"\" AS report_approve_state            , -- 销假审批状态\n        \"\" AS report_wf_inst_id               , -- 销假流程实例ID\n        \"\" AS reason                          , -- 申请原因\n        \"\" AS remark                          , -- 备注\n        \"\" AS attachment_index                , -- 附件\n        \"\" AS create_time                     , -- 创建时间\n        \"\" AS creator_id                      , -- 创建人员\n        \"\" AS operate_time                    , -- 发生时间\n        \"\" AS operator_id                     , -- 操作人\n        \"\" AS actual_len                      , -- 实际时长\n        \"\" AS business_org_id                 , -- 方案所属考勤组织\n        \"\" AS turn_to_take_off                , -- 转调休\n        \"\" AS updater_id                      , -- 更新人员\n        \"\" AS modified_time                   , -- 修改时间\n        \"\" AS approve_finish_date             , -- 审批结束时间\n        \"\" AS historical_duration             , -- 历史请假时长\n        \"\" AS start_time2                     , -- 开始时间2\n        \"\" AS end_time2                       , -- 结束时间2\n        \"\" AS employee                        , -- 人员\n        \"\" AS business_trip_item              , -- 出差项目\n        \"\" AS business_trip_item_report       , -- 日报项目\n        \"\" AS business_trip_start_time        , -- 开始时间\n        \"\" AS business_trip_end_time          , -- 结束时间\n        \"\" AS business_trip_start_time_plan   , -- 计划开始时间\n        \"\" AS business_trip_end_time_plan     , -- 计划结束时间\n        \"\" AS business_trip_source            , -- 来源\n        \"\" AS business_trip_adapter_id        , -- 线下数据ID\n        \"\" AS business_trip_department_id     , -- 组织\n        \"\" AS business_trip_state             , -- 状态\n        \"\" AS business_trip_approve_state     , -- 审批状态\n        \"\" AS business_trip_wf_inst_id        , -- 流程实例ID\n        \"\" AS business_trip_report_approve_state, -- 销差审批状态\n        \"\" AS business_trip_report_wf_inst_id , -- 销差流程实例ID\n        \"\" AS address                         , -- 出差地点\n        \"\" AS method                          , -- 出差方式\n        \"\" AS business_trip_reason            , -- 申请原因\n        \"\" AS business_trip_remark            , -- 备注\n        \"\" AS business_trip_attachment_index  , -- 附件\n        \"\" AS business_trip_create_time       , -- 创建时间\n        \"\" AS business_trip_creator_id        , -- 创建人员\n        \"\" AS business_trip_operate_time      , -- 发生时间\n        \"\" AS business_trip_operator_id       , -- 操作人\n        \"\" AS business_trip_approve_finish_date, -- 审批结束时间\n        \"\" AS business_trip_updater_id        , -- 更新人员\n        \"\" AS business_trip_modified_time     , -- 修改时间\n        \"\" AS description                       -- 描述\nFROM dwi_hrm.dwi_hrm_attend_record_lz attend_record\nLEFT JOIN dwi_hrm.dwi_dhr_lz_employee_behavior_info_view_xcy_punch_record xcy_punch_record on xcy_punch_record.employee_no=attend_record.user_id AND substr(attend_record.attend_day,1,10)=xcy_punch_record.punch_date\nLEFT JOIN dwi_hrm.dwi_hrm_attend_personal_record_lz attend_personal_record on xcy_punch_record.employee_no=attend_personal_record.user_no\nLEFT JOIN dwi_hrm.dwi_hrm_hr_user_position_lz hr_user_position on xcy_punch_record.employee_no=hr_user_position.user_no\nLEFT JOIN dwi_hrm.dwi_hrm_holiday_book_lz holiday_book on xcy_punch_record.employee_no=holiday_book.user_no AND xcy_punch_record.punch_date=substr(holiday_book.start_time,10)\nwhere substr(attend_record.attend_day,1,10)>'2025-06-01';\n-- SELECT * FROM dwi_hrm.dwi_dhr_lz_employee_behavior_info where main_industry='新产业' LIMIT 20;\n-- SELECT count(1) FROM dwi_hrm.dwi_dhr_lz_employee_behavior_info;\n\n-- SELECT * FROM dwi_hrm.dwi_hrm_hr_user_position_lz where user_no='405122'\n",
	"currentDatabase":"dwi_hrm",
	"description":"",
	"directory":"/廉政专项/DHR/宽表",
	"name":"etl_dwi_dhr_lz_employee_behavior_info",
	"templateVersion":"1.0",
	"type":"SparkSQL"
}